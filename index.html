<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Lager Pro V4.1 ‚Äì Inventur & Rechnungen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#050509" />

  <style>
    :root{
      --bg:#050509;
      --bg-elevated:#11131b;
      --bg-elevated-soft:#151823;
      --border:#2b3040;
      --accent:#2ecc71;
      --accent-soft:rgba(46,204,113,0.18);
      --danger:#ff5c5c;
      --danger-soft:rgba(255,92,92,0.16);
      --text:#f5f5f7;
      --text-soft:#c5c8d8;
      --muted:#8d92a8;
      --radius:10px;
      --shadow-soft:0 14px 35px rgba(0,0,0,0.55);
    }

    *{box-sizing:border-box;}

    body{
      margin:0;
      padding:0;
      font-family:system-ui,-apple-system,"SF Pro Text","Segoe UI",sans-serif;
      background:radial-gradient(circle at top,#202438 0,#050509 55%);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
    }

    .app-shell{
      max-width:1200px;
      margin:0 auto;
      padding:0.8rem 0.9rem 1.2rem;
    }

    header.app-header{
      padding:0.75rem 1rem 0.6rem;
      border-radius:14px;
      background:linear-gradient(120deg,rgba(46,204,113,0.22),rgba(0,0,0,0.65));
      box-shadow:var(--shadow-soft);
      margin-bottom:0.7rem;
    }

    .header-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:0.8rem;
    }

    .app-title{
      display:flex;
      flex-direction:column;
      gap:0.1rem;
    }
    .app-title h1{
      margin:0;
      font-size:1.05rem;
      letter-spacing:0.04em;
      text-transform:uppercase;
    }
    .app-title span{
      font-size:0.7rem;
      color:var(--text-soft);
    }

    .pill{
      padding:0.15rem 0.6rem;
      border-radius:999px;
      border:1px solid rgba(245,245,247,0.25);
      font-size:0.7rem;
      color:var(--text-soft);
      white-space:nowrap;
    }

    /* NAV */
    .nav-bar{
      margin-top:0.6rem;
      display:flex;
      gap:0.4rem;
    }
    .nav-btn{
      padding:0.25rem 0.9rem;
      border-radius:999px;
      border:1px solid rgba(245,245,247,0.18);
      background:rgba(0,0,0,0.25);
      color:var(--text-soft);
      font-size:0.78rem;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:0.3rem;
    }
    .nav-btn.active{
      background:#f5f5f7;
      color:#050509;
      font-weight:600;
      border-color:#f5f5f7;
    }

    /* Statistik Lager */
    #stats{
      margin-top:0.7rem;
      display:flex;
      flex-wrap:wrap;
      gap:0.45rem;
      font-size:0.78rem;
    }
    .stat-chip{
      background:var(--bg-elevated);
      border-radius:999px;
      border:1px solid var(--border);
      padding:0.28rem 0.7rem;
      display:flex;
      align-items:center;
      gap:0.35rem;
      color:var(--muted);
    }
    .stat-chip b{
      color:var(--text);
      font-size:0.8rem;
    }

    /* Umsatz/Gewinn Rechnungen */
    #invoiceStats{
      margin-top:0.7rem;
      display:flex;
      flex-wrap:wrap;
      gap:0.45rem;
      font-size:0.78rem;
    }
    .invoice-chip{
      background:var(--bg-elevated);
      border-radius:999px;
      border:1px solid var(--border);
      padding:0.28rem 0.7rem;
      display:flex;
      align-items:center;
      gap:0.35rem;
      color:var(--muted);
    }
    .invoice-chip b{
      color:var(--text);
      font-size:0.8rem;
    }

    /* TOOLBAR */
    .toolbar{
      margin-top:0.9rem;
      display:flex;
      flex-wrap:wrap;
      gap:0.45rem;
      align-items:center;
      justify-content:space-between;
    }

    .toolbar-left,
    .toolbar-right{
      display:flex;
      flex-wrap:wrap;
      gap:0.4rem;
      align-items:center;
    }

    button{
      cursor:pointer;
      padding:0.32rem 0.85rem;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--bg-elevated-soft);
      color:var(--text);
      font-size:0.8rem;
      display:inline-flex;
      align-items:center;
      gap:0.3rem;
      white-space:nowrap;
      transition:background 0.15s ease,transform 0.1s ease,box-shadow 0.15s ease,border-color 0.15s ease;
    }

    button.primary{
      background:var(--accent);
      border-color:var(--accent);
      color:#03130a;
      font-weight:600;
      box-shadow:0 4px 18px rgba(46,204,113,0.35);
    }
    button.primary:active{
      transform:scale(0.97);
      box-shadow:none;
    }

    button.danger{
      border-color:var(--danger);
      color:var(--danger);
      background:var(--danger-soft);
    }

    button:disabled{
      opacity:0.4;
      cursor:default;
      box-shadow:none;
      transform:none;
    }

    label.btn-like{
      padding:0.32rem 0.85rem;
      border-radius:999px;
      border:1px dashed var(--border);
      background:transparent;
      font-size:0.8rem;
      display:inline-flex;
      align-items:center;
      gap:0.3rem;
      cursor:pointer;
      color:var(--muted);
    }
    label.btn-like input{display:none;}

    input,select{
      padding:0.32rem 0.5rem;
      border-radius:999px;
      border:1px solid var(--border);
      background:#070b13;
      color:var(--text);
      font-size:0.8rem;
      outline:none;
    }
    input[type="search"]{
      flex:1;
      min-width:0;
    }
    input::placeholder{color:var(--muted);}

    select{
      padding-right:1.4rem;
      background-image:linear-gradient(45deg,transparent 50%, var(--muted) 50%),linear-gradient(135deg,var(--muted) 50%,transparent 50%);
      background-position:calc(100% - 12px) calc(50% - 3px),calc(100% - 8px) calc(50% - 3px);
      background-size:4px 4px,4px 4px;
      background-repeat:no-repeat;
    }

    textarea{
      padding:0.35rem 0.4rem;
      border-radius:8px;
      border:1px solid var(--border);
      background:#070b13;
      color:var(--text);
      font-size:0.8rem;
      resize:vertical;
    }

    /* TABLE CARD */
    .table-card{
      margin-top:0.8rem;
      border-radius:14px;
      border:1px solid var(--border);
      background:radial-gradient(circle at top left,rgba(46,204,113,0.04),transparent 56%);
      overflow:hidden;
      box-shadow:0 18px 45px rgba(0,0,0,0.65);
    }

    .table-wrapper{
      max-height:70vh;
      overflow:auto;
    }

    table{
      width:100%;
      border-collapse:collapse;
      min-width:950px;
    }
    th,td{
      padding:0.14rem 0.25rem;
      border-bottom:1px solid #1e2333;
      font-size:0.5rem;
      white-space:nowrap;
    }
    th{
      background:#171b27;
      text-align:left;
      color:var(--muted);
      position:sticky;
      top:0;
      z-index:1;
    }
    tbody tr:nth-child(odd){background:#0e1119;}
    tbody tr:nth-child(even){background:#131722;}
    tbody tr.flagged{
      background:linear-gradient(90deg,rgba(46,204,113,0.11),rgba(14,17,25,1));
    }

    .text-muted{color:var(--muted);}

    .qty-input{
      width:32px !important;
      padding:0.05rem;
      font-size:0.5rem;
      text-align:center;
      border-radius:6px;
      border:1px solid var(--border);
      background:#05070f;
      color:var(--text);
    }

    .badge-low{
      background:var(--accent-soft);
      color:var(--accent);
      padding:0.05rem 0.25rem;
      border-radius:999px;
      font-size:0.42rem;
      margin-left:0.12rem;
    }

    .actions-cell{
      display:flex;
      gap:0.15rem;
      flex-wrap:nowrap;
    }

    .icon-btn{
      border-radius:999px;
      padding:0.12rem 0.28rem;
      font-size:0.6rem;
      border:1px solid var(--border);
      background:#10141f;
      min-width:0;
    }
    .icon-btn.danger{
      border-color:var(--danger);
      background:var(--danger-soft);
      color:var(--danger);
    }

    @media(max-width:800px){
      .app-shell{padding:0.7rem;}
      .header-top{flex-direction:column;align-items:flex-start;}
      .toolbar{flex-direction:column;align-items:stretch;}
      .toolbar-left,.toolbar-right{width:100%;justify-content:flex-start;}
      table{min-width:0;}
      th:nth-child(11),td:nth-child(11){
        display:none;
      }
    }

    /* Dialoge */
    dialog{
      background:#10121c;
      border:1px solid var(--border);
      color:var(--text);
      border-radius:14px;
      padding:1rem 0.95rem 0.9rem;
      width:95%;
      max-width:460px;
      box-shadow:0 24px 70px rgba(0,0,0,0.85);
    }
    dialog::backdrop{
      background:rgba(0,0,0,0.7);
    }

    .dialog-title{
      margin:0 0 0.7rem;
      font-size:0.95rem;
    }

    .form-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
      gap:0.6rem;
    }
    .form-grid label{
      font-size:0.75rem;
      display:flex;
      flex-direction:column;
      gap:0.18rem;
      color:var(--text-soft);
    }
    .form-grid input,.form-grid select,.form-grid textarea{
      border-radius:8px;
    }
    .full-width{grid-column:1/-1;}

    .dialog-menu{
      display:flex;
      justify-content:flex-end;
      gap:0.5rem;
      margin-top:0.9rem;
    }

    .dialog-photo-content img{
      max-width:90vw;
      max-height:70vh;
      border-radius:var(--radius);
      border:1px solid var(--border);
      display:block;
    }

    .small-hint{
      font-size:0.7rem;
      color:var(--muted);
    }

    .inv-pos-row{
      display:flex;
      gap:0.4rem;
      align-items:center;
      margin-bottom:0.35rem;
    }
    .inv-pos-row select{
      flex:1.6;
    }
    .inv-pos-row input{
      flex:0.7;
      min-width:0;
    }
  </style>
</head>

<body>
  <div class="app-shell">
    <header class="app-header">
      <div class="header-top">
        <div class="app-title">
          <h1>Lager Pro V4.1</h1>
          <span>Inventur & Rechnungen ‚Äì lokal auf deinem Ger√§t</span>
        </div>
        <div class="pill">Kleinunternehmer ¬∑ kein MwSt-Ausweis</div>
      </div>

      <!-- Navigation Lager / Rechnungen -->
      <div class="nav-bar">
        <button class="nav-btn active" id="navLager">üì¶ Lager</button>
        <button class="nav-btn" id="navRechnungen">üí∂ Rechnungen</button>
      </div>
    </header>

    <!-- ===== LAGER ===== -->
    <section id="view-lager">
      <div id="stats">
        <div class="stat-chip">Typen: <b id="statCount">0</b></div>
        <div class="stat-chip">Gesamtmenge: <b id="statQty">0</b></div>
        <div class="stat-chip">Einkauf gesamt: <b id="statTotal">0,00 ‚Ç¨</b></div>
      </div>

      <div class="toolbar">
        <div class="toolbar-left">
          <button class="primary" id="btnAdd">Ôºã Artikel</button>
          <label class="btn-like">
            <span>Backup importieren (JSON)</span>
            <input type="file" id="inputImport" accept="application/json">
          </label>
          <button id="btnExportJson">Backup exportieren</button>
          <button id="btnPrintInventur">Inventurliste drucken</button>
        </div>
        <div class="toolbar-right">
          <input id="search" type="search" placeholder="Suche nach Name, Nummer, Zustand, Gr√∂√üe, Shop, Notiz ‚Ä¶">
          <select id="filterFlag">
            <option value="all">Alle</option>
            <option value="flagged">Markierte</option>
          </select>
        </div>
      </div>

      <section class="table-card">
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>‚òÖ</th>
                <th>Art.-Nr.</th>
                <th>Name</th>
                <th>Zustand</th>
                <th>Gr√∂√üe</th>
                <th>Wo gekauft</th>
                <th>Menge</th>
                <th>Preis/Stk (‚Ç¨)</th>
                <th>Gesamt (‚Ç¨)</th>
                <th>Kaufdatum</th>
                <th>Foto</th>
                <th>Notiz</th>
                <th>Aktion</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </section>
    </section>

    <!-- ===== RECHNUNGEN ===== -->
    <section id="view-rechnungen" style="display:none;">
      <div id="invoiceStats">
        <div class="invoice-chip">Umsatz gesamt: <b id="invoiceTotalRevenue">0,00 ‚Ç¨</b></div>
        <div class="invoice-chip">Gewinn / Verlust: <b id="invoiceTotalProfit">0,00 ‚Ç¨</b></div>
      </div>

      <div class="toolbar">
        <div class="toolbar-left">
          <button id="btnCompany">Firmendaten</button>
        </div>
        <div class="toolbar-right">
          <input id="invoiceSearch" type="search" placeholder="Suche nach Rechnungsnr., Name, Artikel, Plattform ‚Ä¶">
        </div>
      </div>

      <section class="table-card" style="margin-top:0.7rem;">
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Nr.</th>
                <th>Datum</th>
                <th>Kunde</th>
                <th>Artikel</th>
                <th>Verkauf (‚Ç¨)</th>
                <th>Gewinn/Verlust (‚Ç¨)</th>
                <th>Plattform</th>
                <th>Zahlung</th>
                <th>Aktion</th>
              </tr>
            </thead>
            <tbody id="invoiceBody"></tbody>
          </table>
        </div>
      </section>
    </section>
  </div>

  <!-- Artikel-Dialog -->
  <dialog id="itemDialog">
    <h3 class="dialog-title">Artikel bearbeiten</h3>
    <form id="itemForm" class="form-grid" onsubmit="return false;">
      <label>
        Artikelnummer
        <input id="itemNumber">
      </label>
      <label>
        Kaufdatum
        <input id="itemDate" type="date">
      </label>
      <label class="full-width">
        Artikelname
        <input id="itemName" required>
      </label>
      <label>
        Zustand
        <select id="itemCondition">
          <option value="">‚Äì bitte w√§hlen ‚Äì</option>
          <option value="Neu">Neu</option>
          <option value="Wie neu">Wie neu</option>
          <option value="Gebraucht">Gebraucht</option>
        </select>
      </label>
      <label>
        Gr√∂√üe
        <input id="itemSize">
      </label>
      <label>
        Wo gekauft
        <input id="itemStore">
      </label>
      <label>
        Menge
        <input id="itemQty" type="number" min="0" value="1">
      </label>
      <label>
        Einkaufspreis pro St√ºck (‚Ç¨)
        <input id="itemPrice" type="number" step="0.01" min="0" value="0">
      </label>
      <label class="full-width">
        Notiz
        <textarea id="itemNote" rows="3" placeholder="z.B. Besonderheiten, Lagerort ‚Ä¶"></textarea>
      </label>
      <label class="full-width">
        Foto
        <input id="itemPhoto" type="file" accept="image/*">
        <span id="itemPhotoInfo" class="small-hint">Kein Foto ausgew√§hlt</span>
      </label>
      <label style="display:flex;align-items:center;gap:0.3rem;">
        <input id="itemFlagged" type="checkbox">
        <span class="small-hint">Artikel markieren</span>
      </label>
      <div class="dialog-menu full-width">
        <button type="button" id="btnCancelItem">Abbrechen</button>
        <button type="button" class="primary" id="btnSaveItem">Speichern</button>
      </div>
    </form>
  </dialog>

  <!-- Foto-Dialog -->
  <dialog id="photoDialog">
    <div class="dialog-photo-content">
      <img id="photoDialogImg" alt="Artikel-Foto">
      <div class="dialog-menu">
        <button type="button" id="btnOpenPhoto" class="primary">Bild √∂ffnen (Speichern m√∂glich)</button>
        <button type="button" id="btnClosePhoto" class="primary">Schlie√üen</button>
      </div>
    </div>
  </dialog>

  <!-- Notiz-Dialog -->
  <dialog id="noteDialog">
    <h3 style="margin-top:0;font-size:0.9rem;">Notiz</h3>
    <pre id="noteDialogText" style="white-space:pre-wrap;font-size:0.75rem;"></pre>
    <div class="dialog-menu">
      <button type="button" id="btnCloseNote" class="primary">Schlie√üen</button>
    </div>
  </dialog>

  <!-- Rechnungs-Dialog -->
  <dialog id="invoiceDialog">
    <h3 class="dialog-title">Rechnung erstellen</h3>
    <form id="invoiceForm" class="form-grid" onsubmit="return false;">
      <label class="full-width">
        K√§ufer Name
        <input id="invBuyerName">
      </label>
      <label class="full-width">
        K√§ufer Adresse (Stra√üe, Nr.)
        <input id="invBuyerAddress">
      </label>
      <label>
        PLZ / Ort
        <input id="invBuyerCity">
      </label>
      <label>
        Plattform (z.B. Vinted, eBay)
        <input id="invPlatform">
      </label>
      <label>
        Zahlungsart
        <input id="invPaymentMethod" placeholder="z.B. Vinted, PayPal, Bar">
      </label>
      <label>
        Verkaufsdatum
        <input id="invSaleDate" type="date">
      </label>

      <label class="full-width">
        Positionen (Artikel / Menge / Verkauf ‚Ç¨)
      </label>
      <div id="invoicePositions" class="full-width"></div>
      <button type="button" id="btnAddPosition">+ Position hinzuf√ºgen</button>

      <div class="dialog-menu full-width">
        <button type="button" id="btnCancelInvoice">Abbrechen</button>
        <button type="button" class="primary" id="btnSaveInvoice">Rechnung erstellen</button>
      </div>
    </form>
  </dialog>

  <!-- Firmendaten-Dialog -->
  <dialog id="companyDialog">
    <h3 class="dialog-title">Firmendaten</h3>
    <form id="companyForm" class="form-grid" onsubmit="return false;">
      <label class="full-width">
        Firmenname / dein Name
        <input id="companyName">
      </label>
      <label class="full-width">
        Stra√üe / Nr.
        <input id="companyAddress">
      </label>
      <label>
        PLZ / Ort
        <input id="companyCity">
      </label>
      <label>
        E-Mail
        <input id="companyEmail">
      </label>
      <label>
        Telefon
        <input id="companyPhone">
      </label>
      <label class="full-width">
        Umsatzsteuer-ID (optional)
        <input id="companyVatId">
      </label>
      <label class="full-width">
        Fu√ütext auf Rechnung
        <textarea id="companyFooter" rows="4"
          placeholder="Dein eigener Text ‚Ä¶"></textarea>
      </label>
      <div class="dialog-menu full-width">
        <button type="button" id="btnCancelCompany">Abbrechen</button>
        <button type="button" class="primary" id="btnSaveCompany">Speichern</button>
      </div>
    </form>
  </dialog>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const ITEM_STORAGE_KEY = "lager-pro-v4-items";
      const INVOICE_STORAGE_KEY = "lager-pro-v4-invoices";
      const INVOICE_COUNTER_KEY = "lager-pro-v4-invoice-counter";
      const COMPANY_STORAGE_KEY = "lager-pro-v4-company";

      let items = [];
      let invoices = [];
      let company = {
        name: "OneByOneFashion",
        address: "",
        city: "98683 Ilmenau",
        email: "OneByOneFashion@myyahoo.com",
        phone: "",
        vatId: "DE359019064",
        footer: ""
      };
      let currentItemId = null;
      let tempPhotoDataUrl = null;

      const tbody = document.getElementById("tbody");
      const invoiceBody = document.getElementById("invoiceBody");

      const itemDialog = document.getElementById("itemDialog");
      const itemForm = document.getElementById("itemForm");

      const invoiceDialog = document.getElementById("invoiceDialog");
      const invoiceForm = document.getElementById("invoiceForm");
      const invoicePositions = document.getElementById("invoicePositions");

      const photoDialog = document.getElementById("photoDialog");
      const photoDialogImg = document.getElementById("photoDialogImg");

      const noteDialog = document.getElementById("noteDialog");
      const noteDialogText = document.getElementById("noteDialogText");

      const companyDialog = document.getElementById("companyDialog");

      const statCount = document.getElementById("statCount");
      const statQty = document.getElementById("statQty");
      const statTotal = document.getElementById("statTotal");

      const invoiceTotalRevenueEl = document.getElementById("invoiceTotalRevenue");
      const invoiceTotalProfitEl = document.getElementById("invoiceTotalProfit");

      const navLager = document.getElementById("navLager");
      const navRechnungen = document.getElementById("navRechnungen");
      const viewLager = document.getElementById("view-lager");
      const viewRechnungen = document.getElementById("view-rechnungen");

      /* NAV */
      navLager.addEventListener("click", () => {
        navLager.classList.add("active");
        navRechnungen.classList.remove("active");
        viewLager.style.display = "";
        viewRechnungen.style.display = "none";
      });

      navRechnungen.addEventListener("click", () => {
        navRechnungen.classList.add("active");
        navLager.classList.remove("active");
        viewLager.style.display = "none";
        viewRechnungen.style.display = "";
        renderInvoices();
      });

      /* Daten laden */
      loadItems();
      loadInvoices();
      loadCompany();
      render();
      renderInvoices();

      /* Buttons Lager */
      document.getElementById("btnAdd").addEventListener("click", () => openItemDialog(null));
      document.getElementById("btnCancelItem").addEventListener("click", () => itemDialog.close());
      document.getElementById("btnSaveItem").addEventListener("click", saveItem);

      document.getElementById("btnExportJson").addEventListener("click", () => exportJson({ items, invoices }));
      document.getElementById("btnPrintInventur").addEventListener("click", () => printInventur(items));

      document.getElementById("btnClosePhoto").addEventListener("click", () => photoDialog.close());
      document.getElementById("btnOpenPhoto").addEventListener("click", () => {
        if (!photoDialogImg.src) return;
        window.open(photoDialogImg.src, "_blank");
      });

      document.getElementById("btnCloseNote").addEventListener("click", () => noteDialog.close());

      document.getElementById("search").addEventListener("input", () => render());
      document.getElementById("filterFlag").addEventListener("change", () => render());

      document.getElementById("inputImport").addEventListener("change", async (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        try {
          const data = await importJson(file);
          if (Array.isArray(data)) {
            items = data;
          } else if (data && typeof data === "object") {
            if (Array.isArray(data.items)) items = data.items;
            if (Array.isArray(data.invoices)) invoices = data.invoices;
          }
          saveItems();
          saveInvoices();
          render();
          renderInvoices();
          alert("Backup importiert.");
        } catch (err) {
          console.error(err);
          alert("Fehler beim Import.");
        } finally {
          e.target.value = "";
        }
      });

      document.getElementById("itemPhoto").addEventListener("change", (e) => {
        const file = e.target.files?.[0];
        const info = document.getElementById("itemPhotoInfo");
        if (!file) {
          tempPhotoDataUrl = null;
          info.textContent = "Kein Foto ausgew√§hlt";
          return;
        }
        const reader = new FileReader();
        reader.onload = () => {
          tempPhotoDataUrl = reader.result;
          info.textContent = "Foto ausgew√§hlt";
        };
        reader.readAsDataURL(file);
      });

      /* Tabellenaktionen Lager */
      tbody.addEventListener("click", (e) => {
        const btn = e.target.closest("button");
        if (!btn) return;
        const id = btn.dataset.id;
        const action = btn.dataset.action;
        if (!id || !action) return;

        const item = items.find(i => i.id === id);
        if (!item) return;

        switch (action) {
          case "flag":
            item.flagged = !item.flagged;
            saveItems();
            render();
            break;
          case "edit":
            openItemDialog(id);
            break;
          case "photo":
            if (item.photoDataUrl) {
              photoDialogImg.src = item.photoDataUrl;
              photoDialog.showModal();
            }
            break;
          case "note":
            if (item.note) {
              noteDialogText.textContent = item.note;
              noteDialog.showModal();
            }
            break;
          case "delete":
            if (confirm("Diesen Artikel wirklich l√∂schen?")) {
              items = items.filter(i => i.id !== id);
              saveItems();
              render();
            }
            break;
          case "invoice":
            openInvoiceDialogFromItem(item);
            break;
        }
      });

      /* Lager-Menge direkt editieren */
      document.addEventListener("input", (e) => {
        if (!e.target.classList.contains("qty-input")) return;
        const id = e.target.dataset.id;
        const value = Number(e.target.value);
        const item = items.find(i => i.id === id);
        if (!item) return;
        item.quantity = isNaN(value) ? 0 : value;
        saveItems();
        render();
      });

      /* Rechnungen Buttons */
      document.getElementById("btnCancelInvoice").addEventListener("click", () => invoiceDialog.close());
      document.getElementById("btnSaveInvoice").addEventListener("click", saveInvoice);
      document.getElementById("btnAddPosition").addEventListener("click", () => addInvoicePositionRow());

      document.getElementById("invoiceSearch").addEventListener("input", () => renderInvoices());

      /* Rechnungen Tabellenaktionen */
      invoiceBody.addEventListener("click", (e) => {
        const btn = e.target.closest("button");
        if (!btn) return;
        const id = btn.dataset.id;
        const action = btn.dataset.action;
        if (!id || !action) return;

        const inv = invoices.find(r => r.id === id);
        if (!inv) return;

        switch (action) {
          case "view":
            openInvoicePreview(inv, false);
            break;
          case "print":
            openInvoicePreview(inv, true);
            break;
          case "delete":
            if (confirm("Diese Rechnung wirklich l√∂schen?")) {
              invoices = invoices.filter(r => r.id !== id);
              saveInvoices();
              renderInvoices();
            }
            break;
        }
      });

      /* Positionen l√∂schen (Delegation) */
      invoicePositions.addEventListener("click", (e) => {
        const btn = e.target.closest("button.inv-pos-remove");
        if (!btn) return;
        const row = btn.closest(".inv-pos-row");
        if (row) row.remove();
      });

      /* Firmendaten */
      document.getElementById("btnCompany").addEventListener("click", () => openCompanyDialog());
      document.getElementById("btnCancelCompany").addEventListener("click", () => companyDialog.close());
      document.getElementById("btnSaveCompany").addEventListener("click", saveCompany);

      /* Artikel-Dialog √∂ffnen */
      function openItemDialog(id) {
        currentItemId = id;
        tempPhotoDataUrl = null;
        itemForm.reset();
        document.getElementById("itemPhotoInfo").textContent = "Kein Foto ausgew√§hlt";
        const flagEl = document.getElementById("itemFlagged");
        if (flagEl) flagEl.checked = false;

        if (id) {
          const item = items.find(i => i.id === id);
          if (item) {
            setValue("itemNumber", item.articleNumber);
            setValue("itemDate", item.purchaseDate);
            setValue("itemName", item.name);
            setValue("itemCondition", item.condition);
            setValue("itemSize", item.size);
            setValue("itemStore", item.store);
            setValue("itemQty", item.quantity ?? 0);
            setValue("itemPrice", item.price ?? 0);
            setValue("itemNote", item.note || "");
            if (flagEl) flagEl.checked = !!item.flagged;
            if (item.photoDataUrl) {
              document.getElementById("itemPhotoInfo").textContent = "Foto gespeichert (optional neues w√§hlen)";
            }
          }
        }
        itemDialog.showModal();
      }

      /* Artikel speichern */
      function saveItem() {
        const name = getValue("itemName").trim();
        if (!name) {
          alert("Bitte einen Artikelnamen eingeben.");
          return;
        }
        const articleNumber = getValue("itemNumber").trim();
        const purchaseDate = getValue("itemDate");
        const condition = getValue("itemCondition");
        const size = getValue("itemSize").trim();
        const store = getValue("itemStore").trim();
        const qty = Number(getValue("itemQty") || 0);
        const price = Number(getValue("itemPrice") || 0);
        const note = getValue("itemNote").trim();
        const flagged = document.getElementById("itemFlagged")?.checked || false;

        let item = currentItemId ? items.find(i => i.id === currentItemId) : null;
        if (!item) {
          item = { id: (crypto.randomUUID ? crypto.randomUUID() : String(Date.now())) };
          items.push(item);
        }

        item.articleNumber = articleNumber;
        item.purchaseDate = purchaseDate;
        item.name = name;
        item.condition = condition;
        item.size = size;
        item.store = store;
        item.quantity = qty;
        item.price = price;
        item.note = note;
        item.flagged = flagged;

        if (tempPhotoDataUrl) {
          item.photoDataUrl = tempPhotoDataUrl;
        }

        saveItems();
        render();
        itemDialog.close();
      }

      /* Artikel-Storage */
      function loadItems() {
        try {
          const raw = localStorage.getItem(ITEM_STORAGE_KEY);
          items = raw ? JSON.parse(raw) : [];
        } catch {
          items = [];
        }
      }
      function saveItems() {
        localStorage.setItem(ITEM_STORAGE_KEY, JSON.stringify(items));
      }

      /* Rechnungs-Storage */
      function loadInvoices() {
        try {
          const raw = localStorage.getItem(INVOICE_STORAGE_KEY);
          invoices = raw ? JSON.parse(raw) : [];
        } catch {
          invoices = [];
        }
      }
      function saveInvoices() {
        localStorage.setItem(INVOICE_STORAGE_KEY, JSON.stringify(invoices));
      }

      /* Firmendaten-Storage */
      function loadCompany() {
        try {
          const raw = localStorage.getItem(COMPANY_STORAGE_KEY);
          if (raw) {
            const loaded = JSON.parse(raw);
            company = { ...company, ...loaded };
          }
        } catch {
          // fallback: defaults bleiben
        }
      }
      function openCompanyDialog() {
        setValue("companyName", company.name || "");
        setValue("companyAddress", company.address || "");
        setValue("companyCity", company.city || "");
        setValue("companyEmail", company.email || "");
        setValue("companyPhone", company.phone || "");
        setValue("companyVatId", company.vatId || "");
        setValue("companyFooter", company.footer || "");
        companyDialog.showModal();
      }
      function saveCompany() {
        const obj = {
          name: getValue("companyName").trim(),
          address: getValue("companyAddress").trim(),
          city: getValue("companyCity").trim(),
          email: getValue("companyEmail").trim(),
          phone: getValue("companyPhone").trim(),
          vatId: getValue("companyVatId").trim(),
          footer: getValue("companyFooter").trim()
        };
        company = { ...company, ...obj };
        localStorage.setItem(COMPANY_STORAGE_KEY, JSON.stringify(company));
        companyDialog.close();
      }

      /* Rendering Lager */
      function render() {
        tbody.innerHTML = "";
        const search = document.getElementById("search").value.toLowerCase();
        const filterFlag = document.getElementById("filterFlag").value;

        const filtered = items.filter(i => {
          if (filterFlag === "flagged" && !i.flagged) return false;
          const hay = (
            (i.name || "") + " " +
            (i.articleNumber || "") + " " +
            (i.condition || "") + " " +
            (i.size || "") + " " +
            (i.store || "") + " " +
            (i.note || "")
          ).toLowerCase();
          if (search && !hay.includes(search)) return false;
          return true;
        });

        if (!filtered.length) {
          const tr = document.createElement("tr");
          tr.innerHTML = '<td colspan="13" style="text-align:center;padding:0.4rem;font-size:0.6rem;">Keine Artikel</td>';
          tbody.appendChild(tr);
          updateStats();
          return;
        }

        for (const item of filtered) {
          const tr = document.createElement("tr");
          if (item.flagged) tr.classList.add("flagged");
          const qty = Number(item.quantity || 0);
          const price = Number(item.price || 0);
          const total = qty * price;
          tr.innerHTML = `
            <td>${item.flagged ? "‚≠ê" : ""}</td>
            <td>${escapeHtml(item.articleNumber || "")}</td>
            <td>${escapeHtml(item.name || "")}</td>
            <td>${escapeHtml(item.condition || "")}</td>
            <td>${escapeHtml(item.size || "")}</td>
            <td>${escapeHtml(item.store || "")}</td>
            <td>
              <input type="number" min="0" value="${qty}" class="qty-input" data-id="${item.id}">
              ${qty <= 1 ? '<span class="badge-low">niedrig</span>' : ""}
            </td>
            <td>${price.toFixed(2).replace(".", ",")}</td>
            <td>${total.toFixed(2).replace(".", ",")}</td>
            <td>${escapeHtml(item.purchaseDate || "")}</td>
            <td>${item.photoDataUrl ? '<span class="text-muted">Foto</span>' : '<span class="text-muted">‚Äì</span>'}</td>
            <td>
              ${item.note
                ? `<button class="icon-btn" data-action="note" data-id="${item.id}" title="Notiz anzeigen">üìù</button>`
                : '<span class="text-muted">‚Äì</span>'}
            </td>
            <td>
              <div class="actions-cell">
                <button class="icon-btn" data-action="flag" data-id="${item.id}" title="Markieren">‚≠ê</button>
                <button class="icon-btn" data-action="edit" data-id="${item.id}" title="Bearbeiten">‚úèÔ∏è</button>
                <button class="icon-btn" data-action="photo" data-id="${item.id}" title="Foto anzeigen" ${item.photoDataUrl ? "" : "disabled"}>üì∑</button>
                <button class="icon-btn" data-action="invoice" data-id="${item.id}" title="Rechnung aus Artikel erstellen">üßæ</button>
                <button class="icon-btn danger" data-action="delete" data-id="${item.id}" title="L√∂schen">üóëÔ∏è</button>
              </div>
            </td>
          `;
          tbody.appendChild(tr);
        }
        updateStats();
      }

      function updateStats() {
        const count = items.length;
        const totalQty = items.reduce((sum, i) => sum + Number(i.quantity || 0), 0);
        const totalPrice = items.reduce((sum, i) => {
          const qty = Number(i.quantity || 0);
          const price = Number(i.price || 0);
          return sum + qty * price;
        }, 0);
        statCount.textContent = count;
        statQty.textContent = totalQty;
        statTotal.textContent = totalPrice.toFixed(2).replace(".", ",") + " ‚Ç¨";
      }

      /* Inventur drucken */
      function printInventur(list) {
        const win = window.open("", "_blank");
        if (!win) return;
        const rows = list.map(i => {
          const qty = Number(i.quantity || 0);
          const price = Number(i.price || 0);
          const total = qty * price;
          return `
            <tr>
              <td>${escapeHtml(i.articleNumber || "")}</td>
              <td>${escapeHtml(i.name || "")}</td>
              <td>${escapeHtml(i.condition || "")}</td>
              <td>${escapeHtml(i.size || "")}</td>
              <td>${escapeHtml(i.store || "")}</td>
              <td style="text-align:right;">${qty}</td>
              <td style="text-align:right;">${price.toFixed(2).replace(".", ",")}</td>
              <td style="text-align:right;">${total.toFixed(2).replace(".", ",")}</td>
              <td>${escapeHtml(i.purchaseDate || "")}</td>
              <td>${escapeHtml(i.note || "")}</td>
            </tr>
          `;
        }).join("");
        const totalAll = list.reduce((sum,i)=>{
          const qty = Number(i.quantity||0);
          const price = Number(i.price||0);
          return sum + qty*price;
        },0);
        win.document.write(`
          <html>
            <head>
              <meta charset="UTF-8">
              <title>Inventur ‚Äì Lagerbestand</title>
              <style>
                body{
                  font-family:system-ui,sans-serif;
                  font-size:10pt;
                  padding:10mm;
                  background:#ffffff;
                  color:#000000;
                }
                h1{font-size:14pt;margin-bottom:6mm;}
                table{width:100%;border-collapse:collapse;}
                th,td{
                  border:1px solid #000;
                  padding:2px 4px;
                  font-size:9pt;
                  vertical-align:top;
                }
                th{
                  text-align:left;
                  background:#eeeeee;
                }
              </style>
            </head>
            <body>
              <h1>Inventur ‚Äì Lagerbestand</h1>
              <p>Erstellt am: ${new Date().toLocaleDateString("de-DE")}</p>
              <table>
                <thead>
                  <tr>
                    <th>Art.-Nr.</th>
                    <th>Name</th>
                    <th>Zustand</th>
                    <th>Gr√∂√üe</th>
                    <th>Wo gekauft</th>
                    <th>Menge</th>
                    <th>Einkauf/Stk (‚Ç¨)</th>
                    <th>Gesamt (‚Ç¨)</th>
                    <th>Kaufdatum</th>
                    <th>Notiz</th>
                  </tr>
                </thead>
                <tbody>
                  ${rows || '<tr><td colspan="10">Keine Artikel</td></tr>'}
                </tbody>
              </table>
              <p><b>Gesamtwert: ${totalAll.toFixed(2).replace(".", ",")} ‚Ç¨</b></p>
              <script>window.print();<\/script>
            </body>
          </html>
        `);
        win.document.close();
      }

      /* Rechnungs-Dialog aus Artikel */
      function openInvoiceDialogFromItem(item) {
        invoiceForm.reset();
        invoicePositions.innerHTML = "";
        const today = new Date().toISOString().slice(0,10);
        document.getElementById("invSaleDate").value = today;
        addInvoicePositionRow(item);
        invoiceDialog.showModal();
      }

      /* Position hinzuf√ºgen */
      function addInvoicePositionRow(preItem) {
        const row = document.createElement("div");
        row.className = "inv-pos-row";

        const select = document.createElement("select");
        select.className = "inv-pos-article";
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "Artikel w√§hlen ‚Ä¶";
        select.appendChild(opt);
        for (const it of items) {
          const o = document.createElement("option");
          o.value = it.id;
          o.textContent = (it.articleNumber ? it.articleNumber + " ‚Äì " : "") + (it.name || "");
          select.appendChild(o);
        }

        const qtyInput = document.createElement("input");
        qtyInput.type = "number";
        qtyInput.min = "1";
        qtyInput.value = "1";

        const priceInput = document.createElement("input");
        priceInput.type = "number";
        priceInput.min = "0";
        priceInput.step = "0.01";
        priceInput.placeholder = "Verkauf ‚Ç¨";

        const removeBtn = document.createElement("button");
        removeBtn.type = "button";
        removeBtn.className = "icon-btn danger inv-pos-remove";
        removeBtn.textContent = "üóëÔ∏è";

        row.appendChild(select);
        row.appendChild(qtyInput);
        row.appendChild(priceInput);
        row.appendChild(removeBtn);
        invoicePositions.appendChild(row);

        if (preItem) {
          select.value = preItem.id;
          if (preItem.price) {
            priceInput.value = preItem.price.toFixed(2);
          }
        }
      }

      /* Rechnung speichern */
      function saveInvoice() {
        const buyerName = getValue("invBuyerName").trim();
        const saleDate = getValue("invSaleDate") || new Date().toISOString().slice(0,10);
        const buyerAddress = getValue("invBuyerAddress").trim();
        const buyerCity = getValue("invBuyerCity").trim();
        const platform = getValue("invPlatform").trim();
        const paymentMethod = getValue("invPaymentMethod").trim();

        const posRows = Array.from(invoicePositions.querySelectorAll(".inv-pos-row"));
        if (!posRows.length) {
          alert("Mindestens eine Position anlegen.");
          return;
        }

        const positions = [];
        let totalRevenue = 0;
        let totalCost = 0;

        for (const row of posRows) {
          const select = row.querySelector(".inv-pos-article");
          const inputs = row.querySelectorAll("input");
          if (inputs.length < 2) continue;
          const qtyInput = inputs[0];
          const priceInput = inputs[1];

          const articleId = select.value;
          if (!articleId) continue;
          const it = items.find(i => i.id === articleId);
          if (!it) continue;

          const qty = Math.max(1, Number(qtyInput.value || 1));
          const salePrice = Number(priceInput.value || 0);
          if (salePrice <= 0) continue;

          const purchasePrice = Number(it.price || 0);
          const costLine = purchasePrice * qty;
          const revLine = salePrice;

          totalRevenue += revLine;
          totalCost += costLine;

          positions.push({
            articleId,
            articleName: it.name || "",
            articleNumber: it.articleNumber || "",
            quantity: qty,
            salePrice: revLine,
            unitPurchasePrice: purchasePrice
          });
        }

        if (!positions.length) {
          alert("Keine g√ºltige Position mit Artikel und Preis.");
          return;
        }

        let counter = 0;
        try {
          counter = Number(localStorage.getItem(INVOICE_COUNTER_KEY) || "0");
        } catch { counter = 0; }
        counter += 1;
        localStorage.setItem(INVOICE_COUNTER_KEY, String(counter));

        const year = new Date(saleDate).getFullYear() || new Date().getFullYear();
        const numberFormatted = "RE-" + year + "-" + String(counter).padStart(3,"0");
        const profit = totalRevenue - totalCost;

        const invoice = {
          id: (crypto.randomUUID ? crypto.randomUUID() : String(Date.now())),
          number: counter,
          numberFormatted,
          saleDate,
          createdAt: new Date().toISOString(),
          buyerName,
          buyerAddress,
          buyerCity,
          platform,
          paymentMethod,
          positions,
          totalRevenue,
          totalCost,
          profit
        };

        invoices.push(invoice);
        saveInvoices();

        // Lagerbestand reduzieren
        for (const pos of positions) {
          const it = items.find(i => i.id === pos.articleId);
          if (!it) continue;
          const currentQty = Number(it.quantity || 0);
          it.quantity = Math.max(0, currentQty - pos.quantity);
        }
        saveItems();

        render();
        renderInvoices();
        invoiceDialog.close();

        if (confirm("Rechnung wurde erstellt. Direkt anzeigen?")) {
          openInvoicePreview(invoice, false);
        }
      }

      /* Rechnungen rendern */
      function renderInvoices() {
        invoiceBody.innerHTML = "";
        const search = document.getElementById("invoiceSearch").value.toLowerCase();

        const filtered = invoices
          .slice()
          .sort((a,b) => (b.number || 0) - (a.number || 0))
          .filter(inv => {
            if (!search) return true;
            const articleNames = (inv.positions || []).map(p => p.articleName || "").join(" ");
            const hay = `
              ${inv.numberFormatted || ""}
              ${inv.saleDate || ""}
              ${inv.buyerName || ""}
              ${inv.buyerCity || ""}
              ${articleNames}
              ${inv.platform || ""}
              ${inv.paymentMethod || ""}
            `.toLowerCase();
            return hay.includes(search);
          });

        if (!filtered.length) {
          const tr = document.createElement("tr");
          tr.innerHTML = '<td colspan="9" style="text-align:center;padding:0.4rem;font-size:0.6rem;">Keine Rechnungen</td>';
          invoiceBody.appendChild(tr);
          updateInvoiceStats();
          return;
        }

        for (const inv of filtered) {
          const articleNames = (inv.positions || []).map(p => p.articleName || "").join(", ");
          const revenue = Number(inv.totalRevenue || 0);
          const profit = Number(inv.profit || 0);
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${escapeHtml(inv.numberFormatted || String(inv.number || ""))}</td>
            <td>${escapeHtml(inv.saleDate || "")}</td>
            <td>${escapeHtml(inv.buyerName || "")}</td>
            <td>${escapeHtml(articleNames || "")}</td>
            <td>${revenue.toFixed(2).replace(".", ",")}</td>
            <td>${profit.toFixed(2).replace(".", ",")}</td>
            <td>${escapeHtml(inv.platform || "")}</td>
            <td>${escapeHtml(inv.paymentMethod || "")}</td>
            <td>
              <div class="actions-cell">
                <button class="icon-btn" data-action="view" data-id="${inv.id}" title="Ansehen">üîç</button>
                <button class="icon-btn" data-action="print" data-id="${inv.id}" title="Drucken/PDF">üñ®Ô∏è</button>
                <button class="icon-btn danger" data-action="delete" data-id="${inv.id}" title="L√∂schen">üóëÔ∏è</button>
              </div>
            </td>
          `;
          invoiceBody.appendChild(tr);
        }

        updateInvoiceStats();
      }

      function updateInvoiceStats() {
        const totalRevenue = invoices.reduce((sum, inv) => sum + Number(inv.totalRevenue || 0), 0);
        const totalProfit = invoices.reduce((sum, inv) => sum + Number(inv.profit || 0), 0);
        invoiceTotalRevenueEl.textContent = totalRevenue.toFixed(2).replace(".", ",") + " ‚Ç¨";
        invoiceTotalProfitEl.textContent = totalProfit.toFixed(2).replace(".", ",") + " ‚Ç¨";
      }

      /* Rechnungsvorschau / Druck mit deinem Layout */
      function openInvoicePreview(inv, autoPrint) {
        const win = window.open("", "_blank");
        if (!win) return;

        const totalRevenue = Number(inv.totalRevenue || 0);
        const profit = Number(inv.profit || 0);

        const sellerName = company.name || "OneByOneFashion";
        const sellerCity = company.city || "98683 Ilmenau";
        const sellerEmail = company.email || "OneByOneFashion@myyahoo.com";
        const vatId = company.vatId || "DE359019064";

        const headerLine =
          sellerName +
          (sellerCity ? " ‚Äì " + sellerCity : "") +
          (vatId ? " ‚Äì USt-ID: " + vatId : "") +
          (sellerEmail ? " ‚Äì E-Mail: " + sellerEmail : "");

        const defaultFooter =
          "Der Rechnungsbetrag wurde bereits √ºber das System von Vinted beglichen.\n" +
          "Es liegt aufgrund des Kleinunternehmerstatus nach ¬ß 19 UStG eine Umsatzsteuerbefreiung vor Das Rechnungsdatum entspricht dem Lieferdatum.\n" +
          "Wir bedanken uns f√ºr den Auftrag und die angenehme Zusammenarbeit.";

        const footerText = (company.footer && company.footer.trim().length)
          ? company.footer
          : defaultFooter;

        const posRows = (inv.positions || []).map(p => {
          const costLine = Number(p.unitPurchasePrice || 0) * Number(p.quantity || 0);
          const profitLine = Number(p.salePrice || 0) - costLine;
          return `
            <tr>
              <td>${escapeHtml(p.articleName || "")}</td>
              <td>${escapeHtml(p.articleNumber || "")}</td>
              <td style="text-align:right;">${p.quantity || 0}</td>
              <td style="text-align:right;">${Number(p.salePrice || 0).toFixed(2).replace(".", ",")}</td>
              <td style="text-align:right;">${costLine.toFixed(2).replace(".", ",")}</td>
              <td style="text-align:right;">${profitLine.toFixed(2).replace(".", ",")}</td>
            </tr>
          `;
        }).join("");

        const createdDate = new Date(inv.createdAt || inv.saleDate || "");
        const createdStr = isNaN(createdDate.getTime())
          ? ""
          : createdDate.toLocaleDateString("de-DE");

        win.document.write(`
          <html>
            <head>
              <meta charset="UTF-8">
              <title>Rechnung ${inv.numberFormatted || ""}</title>
              <style>
                body{
                  font-family:system-ui,-apple-system,"Segoe UI",sans-serif;
                  font-size:10pt;
                  padding:15mm;
                  background:#ffffff;
                  color:#000000;
                }
                .header-line{
                  text-align:right;
                  font-size:8pt;
                  border-bottom:1px solid #000;
                  padding-bottom:2mm;
                  margin-bottom:6mm;
                }
                .top-cols{
                  display:flex;
                  justify-content:space-between;
                  gap:10mm;
                  margin-bottom:6mm;
                }
                .col-left,.col-right{
                  width:50%;
                  font-size:9pt;
                }
                h1{
                  font-size:18pt;
                  margin:0 0 4mm 0;
                  letter-spacing:0.08em;
                }
                table{width:100%;border-collapse:collapse;margin-top:4mm;}
                th,td{
                  border:1px solid #000;
                  padding:2px 4px;
                  font-size:9pt;
                  vertical-align:top;
                }
                th{background:#eeeeee;}
                .small{font-size:8pt;color:#333;white-space:pre-wrap;}
              </style>
            </head>
            <body>
              <div class="header-line">${escapeHtml(headerLine)}</div>

              <div class="top-cols">
                <div class="col-left">
                  <div><b>Rechnung an</b></div>
                  <div>${escapeHtml(inv.buyerName || "")}</div>
                  <div>${escapeHtml(inv.buyerAddress || "")}</div>
                  <div>${escapeHtml(inv.buyerCity || "")}</div>
                </div>
                <div class="col-right" style="text-align:right;">
                  <div><b>${escapeHtml(sellerName)}</b></div>
                  <div>Rechnungsnummer: ${escapeHtml(inv.numberFormatted || String(inv.number || ""))}</div>
                  <div>Rechnungsdatum: ${createdStr}</div>
                  <div>Verkaufsdatum: ${escapeHtml(inv.saleDate || "")}</div>
                </div>
              </div>

              <h1>RECHNUNG</h1>

              <table>
                <thead>
                  <tr>
                    <th>Artikel</th>
                    <th>Art.-Nr.</th>
                    <th>Menge</th>
                    <th>Verkauf (‚Ç¨)</th>
                    <th>Einkaufskosten (‚Ç¨)</th>
                    <th>Gewinn/Verlust (‚Ç¨)</th>
                  </tr>
                </thead>
                <tbody>
                  ${posRows}
                </tbody>
              </table>

              <div style="margin-top:5mm;font-size:9pt;">
                <b>Umsatz gesamt:</b> ${totalRevenue.toFixed(2).replace(".", ",")} ‚Ç¨<br>
                <b>Gewinn/Verlust:</b> ${profit.toFixed(2).replace(".", ",")} ‚Ç¨
              </div>

              <div style="margin-top:6mm;" class="small">
                ${escapeHtml(footerText)}
              </div>

              ${autoPrint ? "<script>window.print();<\/script>" : ""}
            </body>
          </html>
        `);
        win.document.close();
      }

      /* Backup JSON */
      function exportJson(obj) {
        const blob = new Blob([JSON.stringify(obj, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "lagerpro-v4-backup.json";
        a.click();
        URL.revokeObjectURL(url);
      }

      function importJson(file) {
        return new Promise((resolve, reject) => {
          const r = new FileReader();
          r.onload = () => {
            try { resolve(JSON.parse(r.result)); }
            catch (e) { reject(e); }
          };
          r.onerror = reject;
          r.readAsText(file);
        });
      }

      /* Helper */
      function getValue(id){ return document.getElementById(id).value; }
      function setValue(id,v){ document.getElementById(id).value = v ?? ""; }
      function escapeHtml(str){
        return String(str)
          .replace(/&/g,"&amp;")
          .replace(/</g,"&lt;")
          .replace(/>/g,"&gt;");
      }
    });
  </script>
</body>
</html>
