<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#000000">
  <title>LagerPro V4</title>

  <link rel="manifest" href="manifest.webmanifest">

  <style>
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",sans-serif;
      background:#0c0f14;
      color:#fff;
    }
    .topnav{
      display:flex;
      gap:8px;
      padding:10px;
      background:#11151d;
      border-bottom:1px solid #222;
      position:sticky;
      top:0;
      z-index:5;
    }
    .tab-btn{
      flex:1;
      padding:8px 0;
      background:#1b1f29;
      border:1px solid #2c3140;
      border-radius:8px;
      text-align:center;
      color:#9da3b8;
      font-size:0.9rem;
    }
    .tab-btn.active{
      background:#2ecc71;
      color:#041208;
      font-weight:600;
      border-color:#2ecc71;
    }

    .page{
      display:none;
      padding:12px;
    }
    .page.active{
      display:block;
    }

    h2{
      margin-top:0;
      font-size:1rem;
      border-bottom:1px solid #222;
      padding-bottom:6px;
      color:#dce1ee;
    }
  </style>
</head>

<body>

  <!-- Navigation -->
  <div class="topnav">
    <div class="tab-btn active" data-tab="lager">üì¶ Lager</div>
    <div class="tab-btn" data-tab="rechnungen">üí∂ Rechnungen</div>
  </div>

  <!-- Lager Seite -->
  <div class="page active" id="page-lager">
    <h2>Lagerverwaltung</h2>

    <div id="lager-content">
      <!-- Lager kommt sp√§ter -->
    </div>
  </div>

  <!-- Rechnungen Seite -->
  <div class="page" id="page-rechnungen">
    <h2>Rechnungen</h2>

    <div id="rechnungen-content">
      <!-- Rechnungen kommen sp√§ter -->
    </div>
  </div>

  <script>
    /* Navigation */
    document.querySelectorAll(".tab-btn").forEach(btn=>{
      btn.onclick = ()=>{
        document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");

        const tab = btn.dataset.tab;

        document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
        document.getElementById("page-" + tab).classList.add("active");
      };
    });
  </script>

</body>
</html>
<!-- STATISTIK -->
<div id="lager-stats" style="
  background:#11151d;
  padding:10px;
  border:1px solid #222;
  border-radius:8px;
  margin-bottom:12px;
  font-size:0.85rem;
  display:flex;
  gap:15px;
  flex-wrap:wrap;
">
  <div>Typen: <b id="statCount">0</b></div>
  <div>Gesamtmenge: <b id="statQty">0</b></div>
  <div>Einkauf gesamt: <b id="statTotal">0,00 ‚Ç¨</b></div>
</div>

<!-- BUTTONS -->
<div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px;">

  <button id="btnAddItem" style="
    flex:1;
    background:#2ecc71;
    border:none;
    padding:10px;
    border-radius:8px;
    color:#041208;
    font-weight:600;
  ">+ Artikel</button>

  <label style="
    flex:1;
    background:#1b1f29;
    border:1px solid #2c3140;
    padding:10px;
    border-radius:8px;
    text-align:center;
    cursor:pointer;
  ">
    Backup importieren
    <input type="file" id="inputImport" accept="application/json" style="display:none;">
  </label>

  <button id="btnExportJson" style="
    flex:1;
    background:#1b1f29;
    border:1px solid #2c3140;
    padding:10px;
    border-radius:8px;
    color:#9da3b8;
  ">Backup exportieren</button>

  <button id="btnInventur" style="
    flex:1;
    background:#1b1f29;
    border:1px solid #2c3140;
    padding:10px;
    border-radius:8px;
    color:#9da3b8;
  ">Inventurliste</button>

</div>

<!-- SUCHE -->
<div style="display:flex;gap:8px;margin-bottom:12px;">
  <input id="searchLager" type="search" placeholder="Suchen‚Ä¶" style="
    flex:1;
    padding:10px;
    border-radius:8px;
    border:1px solid #2c3140;
    background:#0f131a;
    color:#fff;
  ">
  <select id="filterFlag" style="
    padding:10px;
    border-radius:8px;
    border:1px solid #2c3140;
    background:#0f131a;
    color:#fff;
  ">
    <option value="all">Alle</option>
    <option value="flagged">Markierte</option>
  </select>
</div>

<!-- TABELLE -->
<div style="
  border:1px solid #222;
  border-radius:8px;
  overflow:auto;
">
  <table id="tableLager" style="width:100%;border-collapse:collapse;min-width:900px;">
    <thead style="background:#1b1f29;color:#9da3b8;font-size:0.75rem;">
      <tr>
        <th style="padding:6px;">‚òÖ</th>
        <th>Art.-Nr.</th>
        <th>Name</th>
        <th>Zustand</th>
        <th>Gr√∂√üe</th>
        <th>Shop</th>
        <th>Menge</th>
        <th>Preis (‚Ç¨)</th>
        <th>Gesamt (‚Ç¨)</th>
        <th>Datum</th>
        <th>Foto</th>
        <th>Notiz</th>
        <th>Aktion</th>
      </tr>
    </thead>
    <tbody id="tbodyLager" style="font-size:0.7rem;"></tbody>
  </table>
</div>
<!-- ARTIKEL-DIALOG -->
<dialog id="itemDialog" style="
  background:#11151d;
  color:#fff;
  border:1px solid #2c3140;
  border-radius:10px;
  padding:20px;
  max-width:420px;
  width:90%;
">
  <h3 style="margin-top:0;">Artikel anlegen / bearbeiten</h3>

  <form id="itemForm" onsubmit="return false;" style="display:grid;gap:10px;">

    <input id="itemNumber" placeholder="Artikelnummer" style="padding:10px;border-radius:8px;border:1px solid #2c3140;background:#0f131a;color:#fff;">

    <input id="itemName" required placeholder="Artikelname" style="padding:10px;border-radius:8px;border:1px solid #2c3140;background:#0f131a;color:#fff;">

    <select id="itemCondition" style="padding:10px;border-radius:8px;border:1px solid #2c3140;background:#0f131a;color:#fff;">
      <option value="">Zustand w√§hlen‚Ä¶</option>
      <option>Neu</option>
      <option>Wie neu</option>
      <option>Gebraucht</option>
    </select>

    <input id="itemSize" placeholder="Gr√∂√üe" style="padding:10px;border-radius:8px;border:1px solid #2c3140;background:#0f131a;color:#fff;">

    <input id="itemStore" placeholder="Wo gekauft" style="padding:10px;border-radius:8px;border:1px solid #2c3140;background:#0f131a;color:#fff;">

    <input id="itemQty" type="number" min="0" value="1" placeholder="Menge" style="padding:10px;border-radius:8px;border:1px solid #2c3140;background:#0f131a;color:#fff;">

    <input id="itemPrice" type="number" step="0.01" min="0" value="0" placeholder="Einkaufspreis (‚Ç¨)" style="padding:10px;border-radius:8px;border:1px solid #2c3140;background:#0f131a;color:#fff;">

    <textarea id="itemNote" rows="3" placeholder="Notiz" style="padding:10px;border-radius:8px;border:1px solid #2c3140;background:#0f131a;color:#fff;"></textarea>

    <label style="font-size:0.9rem;">Foto:
      <input type="file" id="itemPhoto" accept="image/*" style="margin-top:4px;">
    </label>
    <div id="itemPhotoInfo" style="font-size:0.8rem;color:#888;">Kein Foto ausgew√§hlt</div>

    <label>
      <input type="checkbox" id="itemFlagged"> Markieren
    </label>

    <div style="display:flex;gap:8px;margin-top:10px;">
      <button id="btnCancelItem" style="flex:1;padding:10px;border-radius:8px;background:#333;color:#fff;border:none;">Abbrechen</button>
      <button id="btnSaveItem" style="flex:1;padding:10px;border-radius:8px;background:#2ecc71;border:none;color:#041208;font-weight:600;">Speichern</button>
    </div>

  </form>
</dialog>
<script>
/* ============================================
   LAGERPRO V4 ‚Äì DATENSTRUKTUREN
============================================ */
let items = [];
let invoices = [];
let company = {
  name: "OneByOneFashion",
  address: "98683 Ilmenau",
  ustid: "DE359019064",
  email: "OneByOneFashion@myyahoo.com"
};

const STORE_ITEMS = "lagerpro_v4_items";
const STORE_INVOICES = "lagerpro_v4_invoices";
const STORE_COMPANY = "lagerpro_v4_company";

/* ============================================
   DATEN LADEN UND SPEICHERN
============================================ */
function loadAll() {
  try { items = JSON.parse(localStorage.getItem(STORE_ITEMS)) || []; } catch { items = []; }
  try { invoices = JSON.parse(localStorage.getItem(STORE_INVOICES)) || []; } catch { invoices = []; }
  try { company = JSON.parse(localStorage.getItem(STORE_COMPANY)) || company; } catch {}
}

function saveAll() {
  localStorage.setItem(STORE_ITEMS, JSON.stringify(items));
  localStorage.setItem(STORE_INVOICES, JSON.stringify(invoices));
  localStorage.setItem(STORE_COMPANY, JSON.stringify(company));
}

loadAll();

/* ============================================
   HILFSFUNKTIONEN
============================================ */
function esc(v){ return String(v||"").replace(/</g,"&lt;"); }
function val(id){ return document.getElementById(id).value; }
function set(id,v){ document.getElementById(id).value = v ?? ""; }

/* ============================================
   LAGER ‚Äì RENDER
============================================ */
function renderLager() {
  const tbody = document.getElementById("tbodyLager");
  tbody.innerHTML = "";

  const search = document.getElementById("searchLager").value.toLowerCase();
  const filterFlag = document.getElementById("filterFlag").value;

  const list = items.filter(it=>{
    if(filterFlag==="flagged" && !it.flagged) return false;

    const hay = `${it.name} ${it.articleNumber} ${it.size} ${it.store} ${it.note}`.toLowerCase();
    return hay.includes(search);
  });

  if(list.length===0){
    tbody.innerHTML = `
      <tr><td colspan="13" style="text-align:center;padding:6px;color:#888;">
        Keine Artikel gefunden
      </td></tr>`;
    updateLagerStats();
    return;
  }

  for(const it of list){
    const qty = Number(it.quantity||0);
    const price = Number(it.price||0);
    const total = qty * price;

    let row = document.createElement("tr");
    row.innerHTML = `
      <td>${it.flagged?"‚≠ê":""}</td>
      <td>${esc(it.articleNumber)}</td>
      <td>${esc(it.name)}</td>
      <td>${esc(it.condition)}</td>
      <td>${esc(it.size)}</td>
      <td>${esc(it.store)}</td>

      <td>
        <input type="number" class="qty-input" data-id="${it.id}"
          value="${qty}" style="
            width:32px;
            padding:3px;
            border-radius:6px;
            border:1px solid #333;
            background:#0f131a;
            color:#fff;
            font-size:0.65rem;
            text-align:center;
        ">
      </td>

      <td>${price.toFixed(2).replace(".",",")}</td>
      <td>${total.toFixed(2).replace(".",",")}</td>
      <td>${esc(it.purchaseDate)}</td>

      <td>${it.photo?"üì∑":"‚Äì"}</td>
      <td>${it.note?"üìù":"‚Äì"}</td>

      <td style="display:flex;gap:4px;">
        <button data-action="flag" data-id="${it.id}">‚≠ê</button>
        <button data-action="edit" data-id="${it.id}">‚úèÔ∏è</button>
        <button data-action="photo" data-id="${it.id}">üì∑</button>
        <button data-action="note" data-id="${it.id}">üìù</button>
        <button data-action="sell" data-id="${it.id}">üí∂</button>
        <button data-action="delete" data-id="${it.id}" style="color:#ff4d4d;">üóëÔ∏è</button>
      </td>
    `;
    tbody.appendChild(row);
  }

  updateLagerStats();
}

/* ============================================
   LAGER ‚Äì STATISTIK
============================================ */
function updateLagerStats(){
  document.getElementById("statCount").textContent = items.length;

  const totalQty = items.reduce((s,i)=>s+Number(i.quantity||0),0);
  document.getElementById("statQty").textContent = totalQty;

  const totalValue = items.reduce((s,i)=>{
    return s + Number(i.quantity||0)*Number(i.price||0);
  },0);

  document.getElementById("statTotal").textContent =
    totalValue.toFixed(2).replace(".",",")+" ‚Ç¨";
}

/* ============================================
   SUCHEN / FILTER
============================================ */
document.getElementById("searchLager").oninput = renderLager;
document.getElementById("filterFlag").onchange = renderLager;

/* ============================================
   TABELLEN-KLICK-AKTIONEN
============================================ */
document.getElementById("tbodyLager").onclick = (e)=>{
  const btn = e.target.closest("button");
  if(!btn) return;

  const id = btn.dataset.id;
  const action = btn.dataset.action;
  const item = items.find(x=>x.id===id);
  if(!item) return;

  switch(action){
    case "flag":
      item.flagged = !item.flagged;
      break;

    case "delete":
      if(confirm("Diesen Artikel l√∂schen?")){
        items = items.filter(x=>x.id!==id);
      }
      break;

    case "photo":
      if(item.photo){
        document.getElementById("photoDialogImg").src = item.photo;
        document.getElementById("photoDialog").showModal();
      }
      break;

    case "note":
      document.getElementById("noteDialogText").textContent = item.note || "Keine Notiz";
      document.getElementById("noteDialog").showModal();
      break;

    case "edit":
      openItemDialog(item);
      break;

    case "sell":
      openInvoiceDialogFromItem(item);
      break;
  }

  saveAll();
  renderLager();
};

/* ============================================
   MENGE DIREKT EDITIERBAR
============================================ */
document.getElementById("tbodyLager").addEventListener("input",(e)=>{
  if(!e.target.classList.contains("qty-input")) return;
  const id = e.target.dataset.id;
  const item = items.find(x=>x.id===id);
  if(!item) return;
  item.quantity = Number(e.target.value||0);
  saveAll();
  renderLager();
});

/* ============================================
   FOTO- UND NOTIZDIALOG SCHLIESSEN
============================================ */
document.getElementById("btnClosePhoto").onclick = ()=>{
  document.getElementById("photoDialog").close();
};

document.getElementById("btnCloseNote").onclick = ()=>{
  document.getElementById("noteDialog").close();
};
</script>
<script>
/* ============================================
   ARTIKEL-DIALOG ‚Äì √ñFFNEN
============================================ */
let editingItem = null;
let tempPhoto = null;

function openItemDialog(item) {
  editingItem = item ? item.id : null;
  tempPhoto = null;

  // Formular zur√ºcksetzen
  document.getElementById("itemForm").reset();
  document.getElementById("itemPhotoInfo").textContent = "Kein Foto ausgew√§hlt";

  if (item) {
    // vorhandene Werte einf√ºgen
    set("itemNumber", item.articleNumber);
    set("itemName", item.name);
    set("itemCondition", item.condition);
    set("itemSize", item.size);
    set("itemStore", item.store);
    set("itemQty", item.quantity);
    set("itemPrice", item.price);
    set("itemNote", item.note);
    set("itemDate", item.purchaseDate);

    document.getElementById("itemFlagged").checked = !!item.flagged;

    if (item.photo) {
      document.getElementById("itemPhotoInfo").textContent =
        "Foto gespeichert (optional neues w√§hlen)";
    }
  }

  document.getElementById("itemDialog").showModal();
}

/* ============================================
   ARTIKEL-DIALOG ‚Äì SCHLIESSEN
============================================ */
document.getElementById("btnCancelItem").onclick = () => {
  document.getElementById("itemDialog").close();
};

/* ============================================
   FOTO EINLESEN
============================================ */
document.getElementById("itemPhoto").addEventListener("change", (e) => {
  const file = e.target.files?.[0];
  const info = document.getElementById("itemPhotoInfo");

  if (!file) {
    tempPhoto = null;
    info.textContent = "Kein Foto ausgew√§hlt";
    return;
  }

  const reader = new FileReader();
  reader.onload = () => {
    tempPhoto = reader.result;
    info.textContent = "Foto ausgew√§hlt";
  };
  reader.readAsDataURL(file);
});

/* ============================================
   ARTIKEL SPEICHERN
============================================ */
document.getElementById("btnSaveItem").onclick = () => {
  const name = val("itemName").trim();
  if (!name) {
    alert("Bitte einen Artikelnamen eingeben.");
    return;
  }

  const newData = {
    articleNumber: val("itemNumber").trim(),
    name,
    condition: val("itemCondition"),
    size: val("itemSize"),
    store: val("itemStore"),
    quantity: Number(val("itemQty") || 0),
    price: Number(val("itemPrice") || 0),
    note: val("itemNote").trim(),
    purchaseDate: val("itemDate"),
    flagged: document.getElementById("itemFlagged").checked
  };

  if (editingItem) {
    // existierendes Item bearbeiten
    const it = items.find(i => i.id === editingItem);
    if (!it) return;

    Object.assign(it, newData);

    if (tempPhoto) it.photo = tempPhoto;

  } else {
    // neues Item anlegen
    const id = crypto.randomUUID ? crypto.randomUUID() : String(Date.now());

    items.push({
      id,
      ...newData,
      photo: tempPhoto || null
    });
  }

  saveAll();
  renderLager();
  document.getElementById("itemDialog").close();
};

/* ============================================
   ARTIKEL-HINZUF√úGEN BUTTON
============================================ */
document.getElementById("btnAddItem").onclick = () => openItemDialog(null);
</script>
<script>
/* ============================================
   INVENTURLISTE DRUCKEN
============================================ */
document.getElementById("btnPrintInventory").onclick = () => {
  const win = window.open("", "_blank");
  if (!win) return;

  const rows = items.map(i => {
    const qty = Number(i.quantity || 0);
    const price = Number(i.price || 0);
    const total = qty * price;

    return `
      <tr>
        <td>${escape(i.articleNumber)}</td>
        <td>${escape(i.name)}</td>
        <td>${escape(i.condition)}</td>
        <td>${escape(i.size)}</td>
        <td>${escape(i.store)}</td>
        <td style="text-align:right">${qty}</td>
        <td style="text-align:right">${price.toFixed(2)}</td>
        <td style="text-align:right">${total.toFixed(2)}</td>
        <td>${escape(i.purchaseDate)}</td>
        <td>${escape(i.note)}</td>
      </tr>
    `;
  }).join("");

  const now = new Date().toLocaleDateString("de-DE");

  win.document.write(`
    <html>
    <head>
      <meta charset="UTF-8">
      <title>Inventurliste</title>
      <style>
        body {
          font-family: system-ui, sans-serif;
          background: #ffffff;
          padding: 20px;
          color: #000;
        }
        h1 {
          text-align: center;
          margin-bottom: 20px;
          font-size: 18pt;
        }
        table {
          width: 100%;
          border-collapse: collapse;
          font-size: 10pt;
        }
        th, td {
          border: 1px solid #000;
          padding: 4px 6px;
        }
        th {
          background: #eee;
          text-align: left;
        }
      </style>
    </head>

    <body>
      <h1>Inventurliste</h1>
      <p>Erstellt am ${now}</p>

      <table>
        <thead>
          <tr>
            <th>Art.-Nr.</th>
            <th>Name</th>
            <th>Zustand</th>
            <th>Gr√∂√üe</th>
            <th>Shop</th>
            <th>Menge</th>
            <th>Preis/Stk</th>
            <th>Gesamt</th>
            <th>Kaufdatum</th>
            <th>Notiz</th>
          </tr>
        </thead>
        <tbody>
          ${rows || '<tr><td colspan="10">Keine Artikel vorhanden</td></tr>'}
        </tbody>
      </table>

      <script>
        window.print();
      <\/script>
    </body>
    </html>
  `);

  win.document.close();
};
</script>
<!-- ============================================
     NAVIGATION ‚Äì LAGER / RECHNUNGEN
============================================ -->
<style>
.navbar {
  display: flex;
  justify-content: center;
  gap: 1rem;
  margin-bottom: 1rem;
}

.nav-btn {
  padding: 0.45rem 1.2rem;
  border-radius: 12px;
  border: 1px solid var(--border);
  background: #141922;
  font-size: 0.85rem;
  color: var(--text);
  cursor: pointer;
  transition: 0.25s;
}

.nav-btn.active {
  background: var(--accent);
  color: #041208;
  border-color: var(--accent);
  font-weight: 600;
  scale: 1.05;
}

.page {
  display: none;
}

.page.active {
  display: block;
}
</style>

<div class="navbar">
  <button id="navLager" class="nav-btn active">üì¶ Lager</button>
  <button id="navRechnung" class="nav-btn">üí∂ Rechnungen</button>
</div>

<!-- Hauptbereiche -->
<div id="pageLager" class="page active">
  <!-- HIER IST DEINE GANZE LAGERSEITE -->
</div>

<div id="pageRechnung" class="page">
  <h2 style="margin:0 0 .5rem 0; font-size:1rem;">Rechnungen</h2>

  <div id="rechnungStats" style="
      background:var(--bg-elevated);
      padding:0.6rem;
      border-radius:var(--radius);
      border:1px solid var(--border);
      font-size:0.75rem;
      margin-bottom:0.7rem;">
    <span>Rechnung gesamt: <b id="statRechnungCount">0</b></span><br>
    <span>Gewinn/Verlust: <b id="statProfit">0,00 ‚Ç¨</b></span>
  </div>

  <button id="btnNewInvoice" class="primary">+ Neue Rechnung</button>

  <div id="invoiceList" style="margin-top:1rem;"></div>
</div>

<script>
/* ============================================
   NAVIGATION
============================================ */
const navLager = document.getElementById("navLager");
const navRechnung = document.getElementById("navRechnung");

const pageLager = document.getElementById("pageLager");
const pageRechnung = document.getElementById("pageRechnung");

function switchPage(page) {
  if (page === "lager") {
    navLager.classList.add("active");
    navRechnung.classList.remove("active");
    pageLager.classList.add("active");
    pageRechnung.classList.remove("active");
  } else {
    navRechnung.classList.add("active");
    navLager.classList.remove("active");
    pageRechnung.classList.add("active");
    pageLager.classList.remove("active");
  }
}

navLager.onclick = () => switchPage("lager");
navRechnung.onclick = () => switchPage("rechnung");
</script>
<script>
/* ============================================
   RECHNUNGS-DATENBANK
============================================ */
const INVOICE_KEY = "lagerproV4-invoices";
let invoices = [];

/* Laden */
function loadInvoices() {
  try {
    const raw = localStorage.getItem(INVOICE_KEY);
    invoices = raw ? JSON.parse(raw) : [];
  } catch {
    invoices = [];
  }
}

/* Speichern */
function saveInvoices() {
  localStorage.setItem(INVOICE_KEY, JSON.stringify(invoices));
}

/* ============================================
   RECHNUNGS-LISTE RENDERN
============================================ */
const invoiceList = document.getElementById("invoiceList");
const statRechnungCount = document.getElementById("statRechnungCount");
const statProfit = document.getElementById("statProfit");

function renderInvoices() {
  invoiceList.innerHTML = "";

  if (invoices.length === 0) {
    invoiceList.innerHTML = `
      <div style="
        padding:0.6rem;
        font-size:0.8rem;
        color:var(--text-muted);">
        Keine Rechnungen vorhanden.
      </div>`;
    statRechnungCount.textContent = "0";
    statProfit.textContent = "0,00 ‚Ç¨";
    return;
  }

  let totalProfit = 0;

  invoices.forEach(inv => {
    const sum = inv.items.reduce((s, it) => s + it.quantity * it.sellPrice, 0);
    const buySum = inv.items.reduce((s, it) => s + it.quantity * it.buyPrice, 0);
    const profit = sum - buySum;
    totalProfit += profit;

    const div = document.createElement("div");
    div.style = `
      background:var(--bg-elevated);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:0.7rem;
      margin-bottom:0.6rem;
      font-size:0.75rem;
    `;

    div.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div>
          <b>Rechnung #${inv.id}</b><br>
          <span style="color:var(--text-muted);">${inv.date}</span>
        </div>

        <button class="icon-btn" data-id="${inv.id}" data-action="open" title="√ñffnen">üìÑ</button>
        <button class="icon-btn danger" data-id="${inv.id}" data-action="delete" title="L√∂schen">üóëÔ∏è</button>
      </div>

      <div style="margin-top:0.5rem;">
        <b>Kunde:</b> ${inv.customerName.replace(/\n/g,"<br>")}
      </div>

      <div style="margin-top:0.5rem;">
        <b>Gesamt:</b> ${sum.toFixed(2).replace(".",",")} ‚Ç¨
      </div>

      <div style="margin-top:0.3rem;">
        <span style="color:${profit >= 0 ? 'var(--accent)' : 'var(--danger)'};">
          ${profit >= 0 ? "Gewinn" : "Verlust"}: ${profit.toFixed(2).replace(".",",")} ‚Ç¨
        </span>
      </div>
    `;

    invoiceList.appendChild(div);
  });

  statRechnungCount.textContent = invoices.length;
  statProfit.textContent = totalProfit.toFixed(2).replace(".",",") + " ‚Ç¨";
}

/* ============================================
   BUTTON-AKTIONEN DER RECHNUNGSLISTE
============================================ */
invoiceList.addEventListener("click", (e) => {
  const btn = e.target.closest("button");
  if (!btn) return;

  const id = btn.dataset.id;
  const action = btn.dataset.action;

  const invoice = invoices.find(i => i.id == id);
  if (!invoice) return;

  switch (action) {
    case "open":
      openInvoicePDF(invoice);
      break;

    case "delete":
      if (confirm("Rechnung wirklich l√∂schen?")) {
        invoices = invoices.filter(i => i.id != id);
        saveInvoices();
        renderInvoices();
      }
      break;
  }
});

/* ============================================
   INITIAL LADEN
============================================ */
loadInvoices();
renderInvoices();
</script>
<!-- ============================================
     RECHNUNG ERSTELLEN ‚Äì DIALOG
============================================ -->
<style>
.invoice-dialog {
  background:#11141c;
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:1rem;
  width:95%;
  max-width:480px;
  color:var(--text);
}

.invoice-grid {
  display:flex;
  flex-direction:column;
  gap:0.6rem;
}

.invoice-grid label {
  font-size:0.8rem;
  display:flex;
  flex-direction:column;
  gap:0.2rem;
}

.invoice-grid input,
.invoice-grid textarea,
.invoice-grid select {
  border-radius:8px;
  border:1px solid var(--border);
  background:#0e1118;
  padding:0.35rem 0.4rem;
  color:var(--text);
  font-size:0.8rem;
}

.invoice-article-row {
  background:#0f131a;
  border:1px solid var(--border);
  border-radius:6px;
  padding:0.5rem;
  margin-bottom:0.5rem;
}

.invoice-article-row b {
  font-size:0.75rem;
}

.invoice-buttons {
  display:flex;
  justify-content:flex-end;
  gap:0.5rem;
  margin-top:0.7rem;
}

.small-btn {
  border:1px solid var(--border);
  padding:0.25rem 0.6rem;
  border-radius:999px;
  background:#141922;
  color:var(--text);
  font-size:0.75rem;
}

.small-btn.primary {
  background:var(--accent);
  color:#041208;
}
</style>

<dialog id="invoiceDialog" class="invoice-dialog">
  <h3 style="margin:0 0 .6rem 0;font-size:0.95rem;">Neue Rechnung erstellen</h3>

  <div class="invoice-grid">

    <label>
      Kunde (Name + Adresse + Stadt)
      <textarea id="invCustomer" rows="3" placeholder="Kunde einf√ºgen‚Ä¶"></textarea>
    </label>

    <label>
      Verkaufsdatum
      <input type="date" id="invDate">
    </label>

    <label>
      Versandkosten (‚Ç¨ ‚Äì optional)
      <input type="number" id="invShipping" min="0" step="0.01" placeholder="z.B. 4.49">
    </label>

    <div>
      <b style="font-size:0.8rem;">Verkaufte Artikel ausw√§hlen:</b>
      <div id="invoiceArticles"></div>
    </div>
  </div>

  <div class="invoice-buttons">
    <button id="invCancel" class="small-btn">Abbrechen</button>
    <button id="invSave" class="small-btn primary">Speichern</button>
  </div>
</dialog>

<script>
/* ============================================
   RECHNUNG ERSTELLEN ‚Äì √ñFFNEN
============================================ */
const invoiceDialog = document.getElementById("invoiceDialog");
const invoiceArticlesDiv = document.getElementById("invoiceArticles");

document.getElementById("btnNewInvoice").onclick = () => {
  openInvoiceDialog();
};

function openInvoiceDialog() {
  document.getElementById("invCustomer").value = "";
  document.getElementById("invDate").value = new Date().toISOString().split("T")[0];
  document.getElementById("invShipping").value = "";

  // Artikel-Liste vorbereiten (nur Name!)
  invoiceArticlesDiv.innerHTML = "";

  items.forEach(it => {
    const row = document.createElement("div");
    row.className = "invoice-article-row";

    row.innerHTML = `
      <b>${escapeHtml(it.name)}</b>
      <label style="margin-top:0.3rem;">
        Menge
        <input type="number" min="0" value="0" data-id="${it.id}" class="invQty">
      </label>
      <label>
        Verkaufspreis (‚Ç¨)
        <input type="number" min="0" step="0.01" value="0" data-id="${it.id}" class="invPrice">
      </label>
    `;

    invoiceArticlesDiv.appendChild(row);
  });

  invoiceDialog.showModal();
}

/* ============================================
   RECHNUNG SPEICHERN
============================================ */
document.getElementById("invCancel").onclick = () => {
  invoiceDialog.close();
};

document.getElementById("invSave").onclick = () => {
  saveNewInvoice();
};

function saveNewInvoice() {
  const customer = document.getElementById("invCustomer").value.trim();
  const date = document.getElementById("invDate").value;
  const shipping = Number(document.getElementById("invShipping").value || 0);

  if (!customer) {
    alert("Bitte Kundendaten eingeben.");
    return;
  }

  const soldItems = [];

  document.querySelectorAll(".invQty").forEach(qtyInput => {
    const qty = Number(qtyInput.value);
    if (qty > 0) {
      const id = qtyInput.dataset.id;
      const price = Number(document.querySelector(`.invPrice[data-id="${id}"]`).value || 0);
      const item = items.find(i => i.id === id);

      if (!item) return;

      soldItems.push({
        id: id,
        name: item.name,
        quantity: qty,
        sellPrice: price,
        buyPrice: item.price,
        photo: item.photoDataUrl || null
      });
    }
  });

  if (soldItems.length === 0) {
    alert("Bitte mindestens 1 Artikel ausw√§hlen.");
    return;
  }

  const invoice = {
    id: Date.now(),
    customerName: customer,
    date: date,
    shipping: shipping,
    items: soldItems
  };

  invoices.push(invoice);
  saveInvoices();
  renderInvoices();

  invoiceDialog.close();

  // sp√§ter in Teil 11:
  // adjustInventoryAfterSale(invoice);
}
</script>
<!-- ============================================
     PDF VIEWER ‚Äì IN-APP ANZEIGE
============================================ -->
<style>
.pdf-overlay {
  position: fixed;
  inset: 0;
  background: #000d;
  backdrop-filter: blur(4px);
  display: none;
  justify-content: center;
  align-items: center;
  padding: 1rem;
  z-index: 9999;
}

.pdf-window {
  background: #fff;
  width: 95%;
  max-width: 900px;
  height: 90vh;
  border-radius: 12px;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.pdf-header {
  background: #f1f1f1;
  padding: 0.6rem;
  display: flex;
  justify-content: space-between;
  border-bottom: 1px solid #ccc;
}

.pdf-header button {
  padding: 0.35rem 0.75rem;
  font-size: 0.8rem;
  border-radius: 8px;
  border: 1px solid #ccc;
  background: #fff;
  cursor: pointer;
}

#pdfFrame {
  flex: 1;
  width: 100%;
  border: none;
}
</style>

<div id="pdfOverlay" class="pdf-overlay">
  <div class="pdf-window">
    <div class="pdf-header">
      <button id="pdfBack">‚¨ÖÔ∏è Zur√ºck</button>
      <div>
        <button id="pdfPrint">üñ®Ô∏è Drucken</button>
        <button id="pdfDownload">‚¨áÔ∏è Speichern</button>
      </div>
    </div>
    <iframe id="pdfFrame"></iframe>
  </div>
</div>

<script>
/* ============================================
   PDF-Overlay Kontrolle
============================================ */
const pdfOverlay = document.getElementById("pdfOverlay");
const pdfFrame   = document.getElementById("pdfFrame");

document.getElementById("pdfBack").onclick = () => {
  pdfOverlay.style.display = "none";
  pdfFrame.src = "";
};

document.getElementById("pdfPrint").onclick = () => {
  pdfFrame.contentWindow.print();
};

document.getElementById("pdfDownload").onclick = () => {
  const link = document.createElement("a");
  link.href = pdfFrame.src;
  link.download = "Rechnung.pdf";
  link.click();
};

/* ============================================
   PDF GENERIEREN (HTML ‚Üí PDF)
============================================ */
function openInvoicePDF(inv) {
  const itemsHTML = inv.items.map(it => {
    const total = it.quantity * it.sellPrice;
    return `
      <tr>
        <td>${escapeHtml(it.name)}</td>
        <td style="text-align:center;">${it.quantity}</td>
        <td style="text-align:right;">${it.sellPrice.toFixed(2).replace(".",",")} ‚Ç¨</td>
        <td style="text-align:right;">${total.toFixed(2).replace(".",",")} ‚Ç¨</td>
      </tr>
    `;
  }).join("");

  const sum = inv.items.reduce((s, it) => s + it.quantity * it.sellPrice, 0);
  const grandTotal = sum + (inv.shipping || 0);

  // Firmeninfos
  const firmName = "OneByOneFashion";
  const firmCity = "98683 Ilmenau";
  const firmUst  = "DE359019064";
  const firmMail = "OneByOneFashion@myyahoo.com";

  const pdfHTML = `
    <html>
    <head>
      <meta charset="UTF-8">
      <title>Rechnung</title>
      <style>
        body {
          font-family: system-ui, sans-serif;
          padding: 30px;
          font-size: 11pt;
          color: #000;
        }
        h1 {
          text-align: left;
          font-size: 20pt;
          margin: 25px 0 15px 0;
          font-weight: 700;
          border-bottom: 2px solid #000;
          padding-bottom: 5px;
          width: 180px;
        }
        .row { display:flex; justify-content:space-between; }
        .firm { text-align:right; font-size:11pt; }
        table {
          width:100%;
          border-collapse: collapse;
          margin-top:20px;
        }
        th, td {
          border-bottom:1px solid #aaa;
          padding:6px;
        }
        th { background:#f3f3f3; text-align:left; }
        .sum-row td { border:none; padding-top:10px; }
        .total {
          font-size:14pt;
          font-weight:700;
        }
      </style>
    </head>
    <body>

      <div class="row">
        <div class="customer">
          <b>Kunde:</b><br>
          ${escapeHtml(inv.customerName).replace(/\n/g,"<br>")}
        </div>

        <div class="firm">
          <b>${firmName}</b><br>
          ${firmCity}<br><br>
          USt-ID: ${firmUst}<br>
          ${firmMail}
        </div>
      </div>

      <h1>RECHNUNG</h1>

      <div style="margin-bottom:20px;">
        <b>Rechnungsnummer:</b> ${inv.id}<br>
        <b>Rechnungsdatum:</b> ${new Date(inv.date).toLocaleDateString("de-DE")}<br>
        <b>Verkaufsdatum:</b> ${new Date(inv.date).toLocaleDateString("de-DE")}<br>
      </div>

      <table>
        <thead>
          <tr>
            <th>Artikel</th>
            <th>Menge</th>
            <th>Preis</th>
            <th>Summe</th>
          </tr>
        </thead>
        <tbody>
          ${itemsHTML}
        </tbody>
      </table>

      <table>
        <tr class="sum-row">
          <td></td><td></td>
          <td style="text-align:right;">Zwischensumme:</td>
          <td style="text-align:right;">${sum.toFixed(2).replace(".",",")} ‚Ç¨</td>
        </tr>

        ${inv.shipping > 0 ? `
        <tr class="sum-row">
          <td></td><td></td>
          <td style="text-align:right;">Versand:</td>
          <td style="text-align:right;">${inv.shipping.toFixed(2).replace(".",",")} ‚Ç¨</td>
        </tr>` : ""}

        <tr class="sum-row total">
          <td></td><td></td>
          <td style="text-align:right;">Gesamt:</td>
          <td style="text-align:right;">${grandTotal.toFixed(2).replace(".",",")} ‚Ç¨</td>
        </tr>
      </table>

      <p style="margin-top:30px; font-size:10pt;">
        Der Rechnungsbetrag wurde bereits √ºber das System von Vinted beglichen.<br>
        Es liegt aufgrund des Kleinunternehmerstatus nach ¬ß 19 UStG eine Umsatzsteuerbefreiung vor.<br>
        Das Rechnungsdatum entspricht dem Lieferdatum.<br><br>
        Wir bedanken uns f√ºr den Auftrag und die angenehme Zusammenarbeit.
      </p>

    </body>
    </html>
  `;

  const blob = new Blob([pdfHTML], { type: "text/html" });
  const url = URL.createObjectURL(blob);

  pdfFrame.src = url;
  pdfOverlay.style.display = "flex";
}
</script>
<script>
/* ============================================
   HILFSFUNKTION F√úR HTML-ESCAPE (wurde oben benutzt)
============================================ */
function escapeHtml(str) {
  return String(str || "")
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;");
}

/* ============================================
   LAGER NACH VERKAUF ANPASSEN
============================================ */
function adjustInventoryAfterSale(invoice) {
  if (!invoice || !Array.isArray(invoice.items)) return;

  invoice.items.forEach(sold => {
    const item = items.find(i => i.id === sold.id);
    if (!item) return; // Verkauf nur von existierenden Lager-Artikeln

    const current = Number(item.quantity || 0);
    const soldQty = Number(sold.quantity || 0);
    const newQty = current - soldQty;

    item.quantity = newQty < 0 ? 0 : newQty;
  });

  // Lager speichern & neu zeichnen
  if (typeof saveAll === "function") {
    saveAll();
  } else {
    // Fallback: nur Items speichern
    try {
      localStorage.setItem(STORE_ITEMS, JSON.stringify(items));
    } catch {}
  }
  if (typeof renderLager === "function") renderLager();
}

/* ============================================
   RECHNUNG SPEICHERN ‚Äì NEUE VERSION
   (√ºberschreibt die alte saveNewInvoice)
============================================ */
function saveNewInvoice() {
  const customer = document.getElementById("invCustomer").value.trim();
  const date = document.getElementById("invDate").value || new Date().toISOString().split("T")[0];
  const shipping = Number(document.getElementById("invShipping").value || 0);

  if (!customer) {
    alert("Bitte Kundendaten eingeben.");
    return;
  }

  const soldItems = [];

  document.querySelectorAll(".invQty").forEach(qtyInput => {
    const qty = Number(qtyInput.value);
    if (qty > 0) {
      const id = qtyInput.dataset.id;
      const price = Number(
        (document.querySelector(`.invPrice[data-id="${id}"]`)?.value) || 0
      );
      const item = items.find(i => i.id === id);
      if (!item) return;

      soldItems.push({
        id,
        name: item.name,
        quantity: qty,
        sellPrice: price,
        buyPrice: Number(item.price || 0),
        photo: item.photo || null
      });
    }
  });

  if (soldItems.length === 0) {
    alert("Bitte mindestens einen Artikel mit Menge > 0 w√§hlen.");
    return;
  }

  const invoice = {
    id: Date.now(),
    customerName: customer,
    date,
    shipping,
    items: soldItems,
    cancelled: false
  };

  invoices.push(invoice);

  // Lagerbestand anpassen
  adjustInventoryAfterSale(invoice);

  // Rechnungen speichern
  if (typeof saveInvoices === "function") saveInvoices();
  if (typeof saveAll === "function") saveAll();

  if (typeof renderInvoices === "function") renderInvoices();
  if (typeof renderLager === "function") renderLager();

  // Dialog schlie√üen
  if (typeof invoiceDialog !== "undefined") invoiceDialog.close();

  // Optional direkt PDF anzeigen
  if (typeof openInvoicePDF === "function") {
    if (confirm("Rechnung erstellt. PDF anzeigen?")) {
      openInvoicePDF(invoice);
    }
  }
}

/* ============================================
   RECHNUNGEN NEU RENDERN ‚Äì MIT STORNO BUTTON
   (√ºberschreibt alte renderInvoices)
============================================ */
function renderInvoices() {
  invoiceList.innerHTML = "";

  if (!Array.isArray(invoices) || invoices.length === 0) {
    invoiceList.innerHTML = `
      <div style="
        padding:0.6rem;
        font-size:0.8rem;
        color:var(--text-muted);">
        Keine Rechnungen vorhanden.
      </div>`;
    statRechnungCount.textContent = "0";
    statProfit.textContent = "0,00 ‚Ç¨";
    return;
  }

  let totalProfit = 0;

  invoices.forEach(inv => {
    const sum = inv.items.reduce((s, it) => s + it.quantity * it.sellPrice, 0);
    const buySum = inv.items.reduce((s, it) => s + it.quantity * it.buyPrice, 0);
    const profit = sum - buySum;
    if (!inv.cancelled) totalProfit += profit;

    const div = document.createElement("div");
    div.style = `
      background:var(--bg-elevated);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:0.7rem;
      margin-bottom:0.6rem;
      font-size:0.75rem;
      opacity:${inv.cancelled ? "0.6" : "1"};
    `;

    const firstLine = (inv.customerName || "").split(/\r?\n/)[0];

    div.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;gap:0.5rem;">
        <div style="min-width:0;">
          <b>Rechnung #${inv.id}</b>${inv.cancelled ? ' <span style="color:var(--danger);">(storniert)</span>' : ""}<br>
          <span style="color:var(--text-muted);">${new Date(inv.date).toLocaleDateString("de-DE")}</span><br>
          <span style="color:var(--text-muted);">${escapeHtml(firstLine || "")}</span>
        </div>

        <div style="display:flex;gap:0.25rem;">
          <button class="icon-btn" data-id="${inv.id}" data-action="open" title="Rechnung anzeigen">üßæ</button>
          <button class="icon-btn" data-id="${inv.id}" data-action="print" title="Drucken">üñ®</button>
          <button class="icon-btn" data-id="${inv.id}" data-action="cancel" title="Stornieren" ${inv.cancelled ? "disabled" : ""}>‚Ü©</button>
          <button class="icon-btn danger" data-id="${inv.id}" data-action="delete" title="L√∂schen">üóëÔ∏è</button>
        </div>
      </div>

      <div style="margin-top:0.4rem;">
        <b>Summe:</b> ${sum.toFixed(2).replace(".",",")} ‚Ç¨
      </div>
      <div style="margin-top:0.2rem;">
        <span style="color:${profit >= 0 ? 'var(--accent)' : 'var(--danger)'};">
          ${profit >= 0 ? "Gewinn" : "Verlust"}: ${profit.toFixed(2).replace(".",",")} ‚Ç¨
          ${inv.cancelled ? " (nicht mehr wirksam)" : ""}
        </span>
      </div>
    `;

    invoiceList.appendChild(div);
  });

  statRechnungCount.textContent = invoices.length;
  statProfit.textContent = totalProfit.toFixed(2).replace(".",",") + " ‚Ç¨";
}

/* ============================================
   STORNO ‚Äì ZUR√úCKBUCHEN IN LAGER
============================================ */
function cancelInvoice(inv) {
  if (!inv || inv.cancelled) return;

  if (!confirm("Diese Rechnung stornieren und Lagerbestand zur√ºckbuchen?")) return;

  inv.items.forEach(sold => {
    let item = items.find(i => i.id === sold.id);

    // Wenn Artikel nicht existiert ‚Üí neu anlegen
    if (!item) {
      item = {
        id: sold.id,
        articleNumber: "",
        name: sold.name,
        condition: "",
        size: "",
        store: "",
        quantity: 0,
        price: sold.buyPrice || 0,
        note: "Automatisch durch Storno angelegt",
        purchaseDate: inv.date,
        flagged: false,
        photo: sold.photo || null
      };
      items.push(item);
    }

    item.quantity = Number(item.quantity || 0) + Number(sold.quantity || 0);
  });

  inv.cancelled = true;

  // Alles speichern & neu zeichnen
  if (typeof saveInvoices === "function") saveInvoices();
  if (typeof saveAll === "function") saveAll();
  if (typeof renderInvoices === "function") renderInvoices();
  if (typeof renderLager === "function") renderLager();
}

/* ============================================
   KLICK-AKTIONEN ERWEITERN (STORNO & PRINT)
============================================ */
invoiceList.addEventListener("click", (e) => {
  const btn = e.target.closest("button");
  if (!btn) return;

  const id = btn.dataset.id;
  const action = btn.dataset.action;
  const invoice = invoices.find(i => i.id == id);
  if (!invoice) return;

  if (action === "cancel") {
    cancelInvoice(invoice);
  } else if (action === "print") {
    if (typeof openInvoicePDF === "function") {
      openInvoicePDF(invoice);
      // Druckknopf oben im Overlay
    }
  }
});
</script>
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>LagerPro V4</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#000000">

  <link rel="manifest" href="manifest.webmanifest">

  <style>
    :root {
      --bg:#000;
      --bg2:#0d0f15;
      --card:#131722;
      --border:#262a33;
      --accent:#2ecc71;
      --accent-soft:rgba(46,204,113,0.15);
      --danger:#ff4b4b;
      --text:#fff;
      --text2:#9aa0b5;
      --radius:10px;
    }

    * { box-sizing:border-box; }

    body {
      margin:0;
      background:var(--bg);
      font-family:-apple-system, BlinkMacSystemFont, "SF Pro", Arial, sans-serif;
      color:var(--text);
      padding:0;
    }

    /* Navigation oben */
    #nav {
      display:flex;
      justify-content:space-around;
      background:#0a0c11;
      padding:0.8rem 0;
      border-bottom:1px solid var(--border);
      position:sticky;
      top:0;
      z-index:10;
    }

    #nav button{
      background:none;
      border:none;
      color:var(--text2);
      font-size:1rem;
      font-weight:600;
      padding:0.4rem 1rem;
      border-radius:30px;
      transition:0.2s;
    }

    #nav button.active{
      color:var(--accent);
      background:var(--accent-soft);
    }

    /* Seiten */
    .page{
      display:none;
      padding:1rem;
      animation:fade 0.2s ease;
    }
    .page.active{display:block;}

    @keyframes fade{
      from{opacity:0; transform:translateY(5px);}
      to{opacity:1; transform:translateY(0);}
    }

    /* Karten & Statistik */
    .statbox{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:0.8rem 1rem;
      margin-bottom:0.6rem;
      font-size:0.8rem;
    }

    .controls{
      display:flex;
      flex-wrap:wrap;
      gap:0.4rem;
      margin-bottom:0.6rem;
    }

    button{
      cursor:pointer;
      padding:0.35rem 0.9rem;
      font-size:0.8rem;
      border-radius:30px;
      border:1px solid var(--border);
      background:#11141c;
      color:var(--text);
    }

    button.primary{
      background:var(--accent);
      color:#00280f;
      border-color:var(--accent);
      font-weight:700;
    }

    button.danger{
      border-color:var(--danger);
      color:var(--danger);
    }

    input, select, textarea{
      background:#11141c;
      border:1px solid var(--border);
      color:var(--text);
      padding:0.4rem 0.6rem;
      border-radius:8px;
      outline:none;
      font-size:0.8rem;
    }

    input[type="search"]{
      flex:1;
    }

    /* Tabelle */
    .tablebox{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      overflow:auto;
    }

    table{
      width:100%;
      border-collapse:collapse;
      min-width:900px;
    }

    th,td{
      padding:0.35rem 0.4rem;
      border-bottom:1px solid #1b1e25;
      font-size:0.65rem;
      white-space:nowrap;
    }

    th{
      background:#151923;
      text-align:left;
      color:var(--text2);
      font-weight:600;
    }

    tr:nth-child(even){
      background:#0f1219;
    }

    tr.flagged{
      background:#123018;
    }

    .qty-small{
      width:32px !important;
      text-align:center;
      padding:0.15rem;
      font-size:0.55rem;
    }

    .icon-btn{
      font-size:0.7rem;
      padding:0.2rem 0.35rem;
      border-radius:50%;
      background:#0f1219;
      border:1px solid var(--border);
    }
    .icon-btn.danger{ border-color:var(--danger); color:var(--danger); }

    /* Dialog */
    dialog{
      background:#11141c;
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:1rem;
      width:90%;
      max-width:420px;
      color:var(--text);
    }
    dialog::backdrop{background:#000a;}

    .form-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
      gap:0.6rem;
    }
    .full{ grid-column:1/-1; }

    .dialog-menu{
      margin-top:0.8rem;
      display:flex;
      justify-content:flex-end;
      gap:0.4rem;
    }

  </style>
</head>

<body>

  <!-- Navigation -->
  <nav id="nav">
    <button id="navLager" class="active">üì¶ Lager</button>
    <button id="navRechnung">üí∂ Rechnungen</button>
  </nav>

  <!-- Seite: LAGER -->
  <section id="pageLager" class="page active">

    <div class="statbox">
      Artikelarten: <b id="statTypes">0</b><br>
      Gesamtmenge: <b id="statQty">0</b><br>
      Einkauf gesamt: <b id="statBuy">0,00 ‚Ç¨</b>
    </div>

    <div class="controls">
      <button class="primary" id="btnAddItem">+ Artikel</button>
      <label>
        <input type="file" id="importJson" accept="application/json" style="display:none;">
        <button>Backup importieren</button>
      </label>
      <button id="btnExportJson">Backup exportieren</button>
      <button id="btnInventur">Inventurliste</button>
    </div>

    <div class="controls">
      <input type="search" id="searchLager" placeholder="Suchen‚Ä¶">
      <select id="filterLager">
        <option value="all">Alle</option>
        <option value="flagged">Markierte</option>
      </select>
    </div>

    <div class="tablebox">
      <table>
        <thead>
          <tr>
            <th>‚òÖ</th>
            <th>Name</th>
            <th>Zustand</th>
            <th>Gr√∂√üe</th>
            <th>Wo gekauft</th>
            <th>Menge</th>
            <th>Einkauf ‚Ç¨</th>
            <th>Foto</th>
            <th>Notiz</th>
            <th>Aktion</th>
          </tr>
        </thead>
        <tbody id="tblLager"></tbody>
      </table>
    </div>

  </section>

  <!-- Seite RECHNUNGEN -->
  <section id="pageRechnung" class="page">

    <div class="statbox">
      Rechnungen gesamt: <b id="statReCount">0</b><br>
      Gewinn/Verlust: <b id="statProfit">0,00 ‚Ç¨</b>
    </div>

    <div class="controls">
      <button class="primary" id="btnNewInvoice">+ Neue Rechnung</button>
      <input type="search" id="searchRe" placeholder="Suchen‚Ä¶">
    </div>

    <div id="invoiceList"></div>

  </section>
    <!-- ============== DIALOGE: LAGER ============== -->

  <!-- Artikel anlegen / bearbeiten -->
  <dialog id="dlgItem">
    <h3 style="margin-top:0;font-size:0.95rem;">Artikel anlegen / bearbeiten</h3>
    <form id="itemForm" class="form-grid" onsubmit="return false;">

      <label>
        Artikelnummer
        <input id="itemNumber">
      </label>

      <label>
        Kaufdatum
        <input id="itemDate" type="date">
      </label>

      <label class="full">
        Artikelname
        <input id="itemName" required>
      </label>

      <label>
        Zustand
        <select id="itemCondition">
          <option value="">‚Äì w√§hlen ‚Äì</option>
          <option>Neu</option>
          <option>Wie neu</option>
          <option>Gebraucht</option>
        </select>
      </label>

      <label>
        Gr√∂√üe
        <input id="itemSize">
      </label>

      <label>
        Wo gekauft
        <input id="itemStore">
      </label>

      <label>
        Menge
        <input id="itemQty" type="number" min="0" value="1">
      </label>

      <label>
        Einkaufspreis/Stk (‚Ç¨)
        <input id="itemPrice" type="number" min="0" step="0.01" value="0">
      </label>

      <label class="full">
        Notiz
        <textarea id="itemNote" rows="3"></textarea>
      </label>

      <label class="full">
        Foto
        <input type="file" id="itemPhoto" accept="image/*">
        <div id="itemPhotoInfo" style="font-size:0.75rem;color:var(--text2);">
          Kein Foto ausgew√§hlt
        </div>
      </label>

      <label style="display:flex;align-items:center;gap:0.3rem;">
        <input type="checkbox" id="itemFlagged">
        <span style="font-size:0.8rem;">Artikel markieren</span>
      </label>

      <div class="dialog-menu full">
        <button type="button" id="btnCancelItem">Abbrechen</button>
        <button type="button" class="primary" id="btnSaveItem">Speichern</button>
      </div>
    </form>
  </dialog>

  <!-- Foto anzeigen -->
  <dialog id="dlgPhoto">
    <img id="dlgPhotoImg" src="" alt="Foto" style="max-width:90vw;max-height:70vh;border-radius:8px;">
    <div class="dialog-menu">
      <button type="button" id="btnClosePhoto">Schlie√üen</button>
    </div>
  </dialog>

  <!-- Notiz anzeigen -->
  <dialog id="dlgNote">
    <h3 style="margin-top:0;font-size:0.9rem;">Notiz</h3>
    <pre id="dlgNoteText" style="white-space:pre-wrap;font-size:0.8rem;"></pre>
    <div class="dialog-menu">
      <button type="button" id="btnCloseNote">Schlie√üen</button>
    </div>
  </dialog>

  <!-- ============== JAVASCRIPT: LAGER ============== -->
  <script>
    /* ------------------ Storage Keys ------------------ */
    const STORE_ITEMS   = "lagerpro_v4_items";
    const STORE_INVOICES= "lagerpro_v4_invoices";
    const STORE_COMPANY = "lagerpro_v4_company";

    /* ------------------ Globale Daten ----------------- */
    let items    = [];
    let invoices = [];
    let company  = {
      name: "OneByOneFashion",
      address: "98683 Ilmenau",
      ustid: "DE359019064",
      email: "OneByOneFashion@myyahoo.com"
    };

    /* ------------------ Helper ------------------------ */
    function esc(str){
      return String(str || "")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;");
    }
    function val(id){ return document.getElementById(id).value || ""; }
    function set(id,v){ document.getElementById(id).value = v ?? ""; }
    function fmtEuro(n){ return Number(n||0).toFixed(2).replace(".",",") + " ‚Ç¨"; }

    /* ------------------ Laden / Speichern ------------- */
    function loadAll(){
      try{ items    = JSON.parse(localStorage.getItem(STORE_ITEMS))   || []; } catch{ items = []; }
      try{ invoices = JSON.parse(localStorage.getItem(STORE_INVOICES))|| []; } catch{ invoices = []; }
      try{
        const c = JSON.parse(localStorage.getItem(STORE_COMPANY));
        if (c) company = c;
      }catch{}
    }
    function saveAll(){
      localStorage.setItem(STORE_ITEMS,    JSON.stringify(items));
      localStorage.setItem(STORE_INVOICES, JSON.stringify(invoices));
      localStorage.setItem(STORE_COMPANY,  JSON.stringify(company));
    }

    loadAll();

    /* ------------------ Navigation -------------------- */
    const navLager    = document.getElementById("navLager");
    const navRechnung = document.getElementById("navRechnung");
    const pageLager   = document.getElementById("pageLager");
    const pageRechnung= document.getElementById("pageRechnung");

    function switchPage(page){
      if(page === "lager"){
        navLager.classList.add("active");
        navRechnung.classList.remove("active");
        pageLager.classList.add("active");
        pageRechnung.classList.remove("active");
      } else {
        navRechnung.classList.add("active");
        navLager.classList.remove("active");
        pageRechnung.classList.add("active");
        pageLager.classList.remove("active");
      }
    }

    navLager.onclick    = () => switchPage("lager");
    navRechnung.onclick = () => switchPage("rechnung");

    /* ------------------ Lager rendern ----------------- */
    const tblLager = document.getElementById("tblLager");

    function updateLagerStats(){
      const types = items.length;
      const qty   = items.reduce((s,i)=>s+Number(i.quantity||0),0);
      const buy   = items.reduce((s,i)=>s+Number(i.quantity||0)*Number(i.price||0),0);

      document.getElementById("statTypes").textContent = types;
      document.getElementById("statQty").textContent   = qty;
      document.getElementById("statBuy").textContent   = fmtEuro(buy);
    }

    function renderLager(){
      tblLager.innerHTML = "";

      const search = document.getElementById("searchLager").value.toLowerCase();
      const filter = document.getElementById("filterLager").value;

      const list = items.filter(it=>{
        if(filter === "flagged" && !it.flagged) return false;
        const hay = `${it.name} ${it.condition} ${it.size} ${it.store} ${it.note}`.toLowerCase();
        return hay.includes(search);
      });

      if (!list.length){
        tblLager.innerHTML = `<tr><td colspan="10" style="text-align:center;padding:0.5rem;color:var(--text2);">Keine Artikel</td></tr>`;
        updateLagerStats();
        return;
      }

      for(const it of list){
        const tr = document.createElement("tr");
        if(it.flagged) tr.classList.add("flagged");

        tr.innerHTML = `
          <td>${it.flagged?"‚≠ê":""}</td>
          <td>${esc(it.name)}</td>
          <td>${esc(it.condition)}</td>
          <td>${esc(it.size)}</td>
          <td>${esc(it.store)}</td>
          <td>
            <input type="number" min="0" class="qty-small" data-id="${it.id}" value="${Number(it.quantity||0)}">
          </td>
          <td>${fmtEuro(it.price)}</td>
          <td>${it.photo ? "üì∑" : "‚Äì"}</td>
          <td>${it.note ? "üìù" : "‚Äì"}</td>
          <td style="display:flex;gap:0.2rem;">
            <button class="icon-btn" data-action="flag"   data-id="${it.id}" title="Markieren">‚≠ê</button>
            <button class="icon-btn" data-action="edit"   data-id="${it.id}" title="Bearbeiten">‚úèÔ∏è</button>
            <button class="icon-btn" data-action="photo"  data-id="${it.id}" title="Foto">üì∑</button>
            <button class="icon-btn" data-action="note"   data-id="${it.id}" title="Notiz">üìù</button>
            <button class="icon-btn" data-action="sell"   data-id="${it.id}" title="Verkaufen">üí∂</button>
            <button class="icon-btn danger" data-action="delete" data-id="${it.id}" title="L√∂schen">üóëÔ∏è</button>
          </td>
        `;
        tblLager.appendChild(tr);
      }

      updateLagerStats();
    }

    /* ------------------ Suche / Filter ---------------- */
    document.getElementById("searchLager").oninput  = renderLager;
    document.getElementById("filterLager").onchange = renderLager;

    /* ------------------ Menge direkt √§ndern ----------- */
    tblLager.addEventListener("input",(e)=>{
      if(!e.target.classList.contains("qty-small")) return;
      const id  = e.target.dataset.id;
      const val = Number(e.target.value||0);
      const it  = items.find(i=>i.id===id);
      if (!it) return;
      it.quantity = val;
      saveAll();
      updateLagerStats();
    });

    /* ------------------ Tabellen-Buttons -------------- */
    tblLager.addEventListener("click",(e)=>{
      const btn = e.target.closest("button");
      if(!btn) return;
      const id  = btn.dataset.id;
      const act = btn.dataset.action;
      const it  = items.find(i=>i.id===id);
      if(!it && act!=="delete") return;

      if(act === "flag"){
        it.flagged = !it.flagged;
      } else if (act === "edit"){
        openItemDialog(it);
        return;
      } else if (act === "photo"){
        if(it.photo){
          document.getElementById("dlgPhotoImg").src = it.photo;
          document.getElementById("dlgPhoto").showModal();
        }
      } else if (act === "note"){
        document.getElementById("dlgNoteText").textContent = it.note || "Keine Notiz";
        document.getElementById("dlgNote").showModal();
      } else if (act === "delete"){
        if(confirm("Artikel wirklich l√∂schen?")){
          const idx = items.findIndex(i=>i.id===id);
          if(idx>=0) items.splice(idx,1);
        }
      } else if (act === "sell"){
        // Platzhalter ‚Äì in Teil C nutzen wir das f√ºr Rechnung
        switchPage("rechnung");
        // sp√§ter: openInvoiceDialogFromItem(it)
      }

      saveAll();
      renderLager();
    });

    document.getElementById("btnClosePhoto").onclick = ()=> document.getElementById("dlgPhoto").close();
    document.getElementById("btnCloseNote").onclick  = ()=> document.getElementById("dlgNote").close();

    /* ------------------ Artikel-Dialog --------------- */
    let editingItemId = null;
    let tempItemPhoto = null;

    function openItemDialog(item){
      editingItemId = item ? item.id : null;
      tempItemPhoto = null;

      document.getElementById("itemForm").reset();
      document.getElementById("itemPhotoInfo").textContent = "Kein Foto ausgew√§hlt";

      if(item){
        set("itemNumber",    item.articleNumber);
        set("itemDate",      item.purchaseDate);
        set("itemName",      item.name);
        set("itemCondition", item.condition);
        set("itemSize",      item.size);
        set("itemStore",     item.store);
        set("itemQty",       item.quantity);
        set("itemPrice",     item.price);
        set("itemNote",      item.note);
        document.getElementById("itemFlagged").checked = !!item.flagged;
        if(item.photo){
          document.getElementById("itemPhotoInfo").textContent = "Foto gespeichert (optional neues w√§hlen)";
        }
      }

      document.getElementById("dlgItem").showModal();
    }

    document.getElementById("btnAddItem").onclick = ()=> openItemDialog(null);
    document.getElementById("btnCancelItem").onclick = ()=> document.getElementById("dlgItem").close();

    document.getElementById("itemPhoto").addEventListener("change",(e)=>{
      const file = e.target.files?.[0];
      const info = document.getElementById("itemPhotoInfo");
      if(!file){
        tempItemPhoto = null;
        info.textContent = "Kein Foto ausgew√§hlt";
        return;
      }
      const r = new FileReader();
      r.onload = ()=>{
        tempItemPhoto = r.result;
        info.textContent = "Foto ausgew√§hlt";
      };
      r.readAsDataURL(file);
    });

    document.getElementById("btnSaveItem").onclick = ()=>{
      const name = val("itemName").trim();
      if(!name){
        alert("Bitte Artikelnamen eingeben.");
        return;
      }

      const data = {
        articleNumber: val("itemNumber").trim(),
        purchaseDate:  val("itemDate"),
        name,
        condition:     val("itemCondition"),
        size:          val("itemSize").trim(),
        store:         val("itemStore").trim(),
        quantity:      Number(val("itemQty") || 0),
        price:         Number(val("itemPrice") || 0),
        note:          val("itemNote").trim(),
        flagged:       document.getElementById("itemFlagged").checked
      };

      let it = editingItemId ? items.find(i=>i.id===editingItemId) : null;
      if(!it){
        it = { id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) };
        items.push(it);
      }
      Object.assign(it, data);
      if(tempItemPhoto) it.photo = tempItemPhoto;

      saveAll();
      renderLager();
      document.getElementById("dlgItem").close();
    };

    /* ------------------ Backup Export/Import ---------- */
    document.getElementById("btnExportJson").onclick = ()=>{
      const data = { items, invoices, company };
      const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement("a");
      a.href = url;
      a.download = "lagerpro-backup.json";
      a.click();
      URL.revokeObjectURL(url);
    };

    document.getElementById("importJson").addEventListener("change",(e)=>{
      const file = e.target.files?.[0];
      if(!file) return;
      const r = new FileReader();
      r.onload = ()=>{
        try{
          const data = JSON.parse(r.result);
          if(Array.isArray(data)){
            items = data;
          }else{
            if(Array.isArray(data.items))    items    = data.items;
            if(Array.isArray(data.invoices)) invoices = data.invoices;
            if(data.company)                 company  = data.company;
          }
          saveAll();
          renderLager();
          alert("Backup importiert.");
        }catch{
          alert("Ung√ºltige Datei.");
        }
      };
      r.readAsText(file);
    });

    /* ------------------ Inventurliste drucken --------- */
    document.getElementById("btnInventur").onclick = ()=>{
      const win = window.open("","_blank");
      if(!win) return;

      const rows = items.map(it=>{
        const qty = Number(it.quantity||0);
        const price = Number(it.price||0);
        const total = qty * price;
        return `
          <tr>
            <td>${esc(it.articleNumber)}</td>
            <td>${esc(it.name)}</td>
            <td>${esc(it.condition)}</td>
            <td>${esc(it.size)}</td>
            <td>${esc(it.store)}</td>
            <td style="text-align:right;">${qty}</td>
            <td style="text-align:right;">${price.toFixed(2).replace(".",",")}</td>
            <td style="text-align:right;">${total.toFixed(2).replace(".",",")}</td>
            <td>${esc(it.purchaseDate||"")}</td>
            <td>${esc(it.note||"")}</td>
          </tr>
        `;
      }).join("");

      const totalAll = items.reduce((s,it)=>{
        return s + Number(it.quantity||0)*Number(it.price||0);
      },0);

      win.document.write(`
        <html>
          <head>
            <meta charset="UTF-8">
            <title>Inventurliste</title>
            <style>
              body{font-family:system-ui,sans-serif;font-size:10pt;padding:10mm;background:#fff;color:#000;}
              h1{font-size:14pt;margin-bottom:6mm;}
              table{width:100%;border-collapse:collapse;}
              th,td{border:1px solid #000;padding:3px 4px;font-size:9pt;}
              th{background:#eee;text-align:left;}
            </style>
          </head>
          <body>
            <h1>Inventurliste</h1>
            <p>Erstellt am: ${new Date().toLocaleDateString("de-DE")}</p>
            <table>
              <thead>
                <tr>
                  <th>Art.-Nr.</th>
                  <th>Name</th>
                  <th>Zustand</th>
                  <th>Gr√∂√üe</th>
                  <th>Wo gekauft</th>
                  <th>Menge</th>
                  <th>Preis/Stk (‚Ç¨)</th>
                  <th>Gesamt (‚Ç¨)</th>
                  <th>Kaufdatum</th>
                  <th>Notiz</th>
                </tr>
              </thead>
              <tbody>
                ${rows || '<tr><td colspan="10">Keine Artikel</td></tr>'}
              </tbody>
            </table>
            <p><b>Gesamtwert: ${totalAll.toFixed(2).replace(".",",")} ‚Ç¨</b></p>
            <script>window.print();<\/script>
          </body>
        </html>
      `);
      win.document.close();
    };

    /* ------------------ Initialrender ----------------- */
    renderLager();
  </script>
  <!-- ============================================
     RECHNUNG ERSTELLEN ‚Äì POPUP
============================================ -->
<dialog id="dlgInvoice">
  <h3 style="margin-top:0;font-size:1rem;">Neue Rechnung erstellen</h3>

  <form id="invoiceForm" onsubmit="return false;" class="form-grid">

    <label class="full">
      Empf√§nger (mehrzeilig)
      <textarea id="invBuyer" rows="3" placeholder="Name&#10;Stra√üe 1&#10;PLZ Ort"></textarea>
    </label>

    <label>
      Verkaufsdatum
      <input type="date" id="invDate">
    </label>

    <label>
      Versandkosten (‚Ç¨)
      <input type="number" id="invShipping" min="0" step="0.01">
    </label>

    <label class="full">
      Artikel ausw√§hlen
      <select id="invAddItem">
        <option value="">‚Äì Artikel hinzuf√ºgen ‚Äì</option>
      </select>
    </label>

    <div id="invItemList" class="full" style="padding:0.4rem;background:#141922;border-radius:8px;border:1px solid #2a2f3b;">
      <h4 style="margin:0 0 .5rem 0;font-size:0.8rem;color:var(--text2);">Artikel in Rechnung</h4>
      <div id="invItems"></div>
    </div>

    <div class="dialog-menu full">
      <button type="button" id="btnCancelInv">Abbrechen</button>
      <button type="button" class="primary" id="btnSaveInv">Rechnung erstellen</button>
    </div>

  </form>
</dialog>

<!-- ============================================
     RECHNUNGS-PDF ANZEIGEN
============================================ -->
<dialog id="dlgPdf" style="width:95%;max-width:900px;height:95%;">
  <div style="display:flex;gap:.4rem;margin-bottom:.5rem;">
    <button id="btnPdfBack">‚Üê Zur√ºck</button>
    <button id="btnPdfPrint" class="primary">Drucken</button>
    <button id="btnPdfSave">Speichern</button>
  </div>

  <iframe id="pdfFrame"
    style="width:100%;height:90%;background:white;border-radius:8px;"></iframe>
</dialog>

<!-- ============================================
     RECHNUNGS-LISTE
============================================ -->
<div id="invoiceSection" style="display:none;">
  <div id="invoiceList" style="margin-top:1rem;"></div>
</div>
<style>
.invoice-card {
  background:#11141c;
  border:1px solid #2a2f3b;
  border-radius:10px;
  padding:0.6rem;
  margin-bottom:0.6rem;
  font-size:0.8rem;
}

.inv-head {
  display:flex;
  justify-content:space-between;
  margin-bottom:0.3rem;
  color:var(--text2);
  font-size:0.75rem;
}

.inv-actions {
  display:flex;
  gap:0.3rem;
  margin-top:0.4rem;
}

.inv-actions button {
  padding:0.25rem 0.5rem;
  border-radius:6px;
  font-size:0.75rem;
}

.inv-item-row {
  display:flex;
  justify-content:space-between;
  margin-bottom:0.2rem;
  background:#0e1118;
  padding:0.2rem 0.4rem;
  border-radius:4px;
}
.inv-item-qty {
  width:32px;
  text-align:center;
}
</style>
<script>
/* ============================================
   DATENSTRUKTUR EINER RECHNUNG
============================================ */
/*
invoice = {
  id: "...",
  date: "YYYY-MM-DD",
  buyer: "... mehrzeilig ...",
  shipping: 0.00,
  items: [
    { id, name, qty, price, photo }
  ],
  total: 0.00
}
*/

/* ============================================
   POPUP √ñFFNEN
============================================ */
let currentInvoiceItems = [];

document.getElementById("btnNewInvoice").onclick = ()=>{
  currentInvoiceItems = [];
  document.getElementById("invoiceForm").reset();
  document.getElementById("invItems").innerHTML = "";
  fillInvoiceItemSelect();
  document.getElementById("dlgInvoice").showModal();
};

/* ============================================
   DROPDOWN MIT ARTIKELN F√úLLEN
============================================ */
function fillInvoiceItemSelect(){
  const sel = document.getElementById("invAddItem");
  sel.innerHTML = `<option value="">‚Äì Artikel hinzuf√ºgen ‚Äì</option>`;
  items.forEach(it=>{
    sel.innerHTML += `<option value="${it.id}">${esc(it.name)}</option>`;
  });
}

/* ============================================
   ARTIKEL ZUR RECHNUNG HINZUF√úGEN
============================================ */
document.getElementById("invAddItem").onchange = ()=>{
  const id = document.getElementById("invAddItem").value;
  if(!id) return;

  const it = items.find(i=>i.id===id);
  if(!it) return;

  const entry = {
    id: it.id,
    name: it.name,
    price: it.price,
    photo: it.photo || null,
    qty: 1
  };

  currentInvoiceItems.push(entry);
  document.getElementById("invAddItem").value = "";
  renderInvoiceItems();
};

function renderInvoiceItems(){
  const box = document.getElementById("invItems");
  box.innerHTML = "";

  currentInvoiceItems.forEach((it,idx)=>{
    const div = document.createElement("div");
    div.className = "inv-item-row";
    div.innerHTML = `
      <span>${esc(it.name)}</span>
      <span>
        <input type="number" min="1" value="${it.qty}" data-idx="${idx}" class="inv-item-qty">
        √ó ${fmtEuro(it.price)}
      </span>
    `;
    box.appendChild(div);
  });
}

/* Menge √§ndern */
document.getElementById("invItems").addEventListener("input",(e)=>{
  if(!e.target.classList.contains("inv-item-qty")) return;
  const idx = Number(e.target.dataset.idx);
  currentInvoiceItems[idx].qty = Number(e.target.value||1);
});

/* ============================================
   RECHNUNG SPEICHERN
============================================ */
document.getElementById("btnSaveInv").onclick = ()=>{
  if(currentInvoiceItems.length === 0){
    alert("Bitte mindestens 1 Artikel hinzuf√ºgen.");
    return;
  }

  const buyer = val("invBuyer").trim();
  const date  = val("invDate");
  const ship  = Number(val("invShipping")||0);

  if(!buyer){
    alert("Bitte Empf√§nger eingeben.");
    return;
  }
  if(!date){
    alert("Bitte Verkaufsdatum eingeben.");
    return;
  }

  /* Gesamt berechnen */
  let total = ship;
  currentInvoiceItems.forEach(it=>{
    total += it.qty * it.price;

    /* Lagerbestand reduzieren */
    const item = items.find(i=>i.id===it.id);
    if(item){
      item.quantity = Math.max(0, Number(item.quantity||0) - it.qty);
    }
  });

  const inv = {
    id: crypto.randomUUID(),
    buyer,
    date,
    shipping: ship,
    items: currentInvoiceItems,
    total
  };

  invoices.push(inv);
  saveAll();
  renderLager();
  renderInvoices();

  document.getElementById("dlgInvoice").close();
};

/* ============================================
   RECHNUNGEN ANZEIGEN
============================================ */
function renderInvoices(){
  const box = document.getElementById("invoiceList");
  box.innerHTML = "";

  if(invoices.length === 0){
    box.innerHTML = `<div style="color:var(--text2);padding:0.4rem;">Keine Rechnungen</div>`;
    return;
  }

  invoices.forEach(inv=>{
    const div = document.createElement("div");
    div.className = "invoice-card";

    div.innerHTML = `
      <div class="inv-head">
        <span>Rechnungs-Nr: ${inv.id.slice(0,8)}</span>
        <span>${inv.date}</span>
      </div>

      <div>
        <b>${esc(inv.buyer).split("\n")[0]}</b><br>
        Gesamt: ${fmtEuro(inv.total)}
      </div>

      <div class="inv-actions">
        <button data-id="${inv.id}" data-action="open">PDF</button>
        <button data-id="${inv.id}" data-action="storno" class="danger">Storno</button>
        <button data-id="${inv.id}" data-action="delete" class="danger">L√∂schen</button>
      </div>
    `;

    box.appendChild(div);
  });
}

/* ============================================
   RECHNUNG BUTTONS (PDF / STORNO / DELETE)
============================================ */
document.getElementById("invoiceList").addEventListener("click",(e)=>{
  const btn = e.target.closest("button");
  if(!btn) return;

  const id = btn.dataset.id;
  const act= btn.dataset.action;
  const inv = invoices.find(i=>i.id===id);
  if(!inv) return;

  if(act === "open") openPdf(inv);
  else if(act === "delete") deleteInvoice(inv);
  else if(act === "storno") stornoInvoice(inv);
});

/* ============================================
   STORNO ‚Äì Lager zur√ºckbuchen
============================================ */
function stornoInvoice(inv){
  if(!confirm("Diese Rechnung stornieren?")) return;

  inv.items.forEach(it=>{
    let item = items.find(i=>i.id===it.id);
    if(item){
      item.quantity += it.qty;
    } else {
      // Artikel wurde entfernt ‚Üí wieder neu anlegen
      items.push({
        id: it.id,
        name: it.name,
        quantity: it.qty,
        price: it.price,
        photo: it.photo || null,
        flagged: false
      });
    }
  });

  invoices = invoices.filter(i=>i.id !== inv.id);
  saveAll();
  renderLager();
  renderInvoices();
}

/* ============================================
   RECHNUNG L√ñSCHEN
============================================ */
function deleteInvoice(inv){
  if(!confirm("Rechnung endg√ºltig l√∂schen?")) return;
  invoices = invoices.filter(i=>i.id !== inv.id);
  saveAll();
  renderInvoices();
}

/* ============================================
   PDF GENERIEREN
============================================ */
function openPdf(inv){
  /* Moderne PDF als HTML */
  const html = buildPdfHtml(inv);

  const blob = new Blob([html], {type:"text/html"});
  const url  = URL.createObjectURL(blob);

  document.getElementById("pdfFrame").src = url;
  document.getElementById("dlgPdf").showModal();

  /* Buttons */
  document.getElementById("btnPdfPrint").onclick = ()=>{
    document.getElementById("pdfFrame").contentWindow.print();
  };
  document.getElementById("btnPdfSave").onclick = ()=>{
    const a = document.createElement("a");
    a.href = url;
    a.download = "rechnung-"+inv.id+".html";
    a.click();
  };
  document.getElementById("btnPdfBack").onclick = ()=>{
    document.getElementById("dlgPdf").close();
  };
}

/* ============================================
   PDF HTML ERZEUGEN
============================================ */
function buildPdfHtml(inv){
  const itemsHtml = inv.items.map(it=>{
    const line = (it.qty * it.price).toFixed(2).replace(".",",");
    return `
      <tr>
        <td>${esc(it.name)}</td>
        <td style="text-align:center;">${it.qty}</td>
        <td style="text-align:right;">${it.price.toFixed(2).replace(".",",")} ‚Ç¨</td>
        <td style="text-align:right;">${line} ‚Ç¨</td>
      </tr>
    `;
  }).join("");

  return `
<!DOCTYPE html><html><head><meta charset="UTF-8">
<title>Rechnung</title>
<style>
  body { font-family: -apple-system, sans-serif; padding:20mm; background:white; }
  h1 { font-size:20pt; margin-top:20mm; }
  table { width:100%; border-collapse:collapse; margin-top:10mm; }
  td,th { border:1px solid #000; padding:4px; font-size:11pt; }
  th { background:#eee; }
</style></head><body>

<!-- Firmenadresse rechts oben -->
<div style="text-align:right;font-size:11pt;line-height:1.2;border-bottom:1px solid #000;padding-bottom:3mm;">
  <b>${company.name}</b><br>
  ${company.address}<br>
  ${company.ustid}<br>
  ${company.email}
</div>

<!-- Empf√§nger -->
<div style="margin-top:10mm;font-size:12pt;white-space:pre-line;">
${esc(inv.buyer)}
</div>

<h1>RECHNUNG</h1>

<table>
<tr>
  <th>Artikel</th>
  <th>Menge</th>
  <th>Preis</th>
  <th>Gesamt</th>
</tr>
${itemsHtml}
</table>

<div style="margin-top:10mm;font-size:13pt;text-align:right;">
  <b>Rechnung gesamt: ${inv.total.toFixed(2).replace(".",",")} ‚Ç¨</b>
</div>

<div style="margin-top:15mm;font-size:11pt;white-space:pre-line;">
Der Rechnungsbetrag wurde bereits √ºber das System von Vinted beglichen.
Es liegt aufgrund des Kleinunternehmerstatus nach ¬ß 19 UStG eine Umsatzsteuerbefreiung vor.
Das Rechnungsdatum entspricht dem Lieferdatum.
Wir bedanken uns f√ºr den Auftrag und die angenehme Zusammenarbeit.
</div>

</body></html>`;
}

/* ============================================
   START
============================================ */
renderInvoices();
</script>
<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js").catch(console.error);
    });
  }
</script>
</body>
</html>
